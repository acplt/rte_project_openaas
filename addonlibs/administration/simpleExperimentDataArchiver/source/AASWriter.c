
/******************************************************************************
 *
 *   FILE
 *   ----
 *   AASWriter.c
 *
 *   History
 *   -------
 *   2018-01-08   File created
 *
 *******************************************************************************
 *
 *   This file is generated by the 'acplt_builder' command
 *
 ******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_simpleExperimentDataArchiver
#define OV_COMPILE_LIBRARY_simpleExperimentDataArchiver
#endif


#include "simpleExperimentDataArchiver.h"

#include "identification_helpers.h"
#include "propertyValueStatement_helpers.h"

typedef enum {
	CONFIGURE = 0,
	SYNC = 1,
	PREPAREARCHIVE = 2,
	WAITING = 3,
	SAVETOFILE = 4,
	CLEANUP = 5,
	FAULT = 99
} WriterState_Types;

OV_DLLFNCEXPORT OV_RESULT simpleExperimentDataArchiver_AASWriter_aasId_set(
		OV_INSTPTR_simpleExperimentDataArchiver_AASWriter          pobj,
		const OV_STRING  value
) {
	return ov_string_setvalue(&pobj->v_aasId,value);
}

OV_DLLFNCEXPORT OV_RESULT simpleExperimentDataArchiver_AASWriter_constructor(
		OV_INSTPTR_ov_object 	pobj
) {
	/*
	 *   local variables
	 */
	//OV_INSTPTR_simpleExperimentDataArchiver_AASWriter pinst = Ov_StaticPtrCast(simpleExperimentDataArchiver_AASWriter, pobj);
	OV_RESULT    result;

	/* do what the base class does first */
	result = simpleExperimentDataArchiver_writer_constructor(pobj);
	if(Ov_Fail(result))
		return result;

	/* do what */
	OV_INSTPTR_ov_domain pTechUnits = NULL;
	pTechUnits = Ov_StaticPtrCast(ov_domain, Ov_SearchChild(ov_containment, &(pdb->root), "TechUnits"));
	OV_INSTPTR_openaas_modelmanager pModelManager = NULL;
	Ov_CreateObject(openaas_modelmanager, pModelManager, pTechUnits, "aasModelManger");

	return OV_ERR_OK;
}

OV_DLLFNCEXPORT void simpleExperimentDataArchiver_AASWriter_destructor(
		OV_INSTPTR_ov_object 	pobj
) {
	/*
	 *   local variables
	 */
	//OV_INSTPTR_simpleExperimentDataArchiver_AASWriter pinst = Ov_StaticPtrCast(simpleExperimentDataArchiver_AASWriter, pobj);

	/* do what */

	/* destroy object */
	simpleExperimentDataArchiver_writer_destructor(pobj);

	return;
}

OV_DLLFNCEXPORT void simpleExperimentDataArchiver_AASWriter_typemethod(
		OV_INSTPTR_fb_functionblock	pfb,
		OV_TIME						*pltc
) {
	/*
	 *   local variables
	 */
	OV_INSTPTR_simpleExperimentDataArchiver_AASWriter pinst = Ov_StaticPtrCast(simpleExperimentDataArchiver_AASWriter, pfb);

	WriterState_Types state = simpleExperimentDataArchiver_writer_state_get(Ov_DynamicPtrCast(simpleExperimentDataArchiver_writer,pinst));
	OV_INSTPTR_simpleExperimentDataArchiver_DataArchiver pSubscription = NULL;
	OV_INSTPTR_simpleExperimentDataArchiver_Variable pVariable = NULL;
	OV_TIME tmpT = {.secs = 0, .usecs = 0};
	OV_TIME_SPAN tmpTS = {.secs = 0, .usecs = 0};
	OV_TIME * timeStamp = NULL;

	/* AAS domain */
	OV_INSTPTR_ov_object pAasDomain = NULL;

	/* AAS */
	AASStatusCode aasResult = AASSTATUSCODE_GOOD;
	IdentificationType aasId  = {.IdSpec = NULL, .IdType = URI};
	OV_STRING aasName = NULL;
	OV_UINT fileIndex = 0;
	OV_STRING tmpAasName = NULL;
	IdentificationType assetId  = {.IdSpec = NULL, .IdType = URI};

	/* SM */
	IdentificationType parentId  = {.IdSpec = NULL, .IdType = URI};
	IdentificationType modelId  = {.IdSpec = NULL, .IdType = URI};

	/* PSVL */
	OV_STRING pvslName = NULL;
	IdentificationType carrierId = {.IdSpec = NULL, .IdType = URI};
	ExpressionLogicEnum expressionLogic = 0;
	ExpressionSemanticEnum expressionSemantic= 0;
	IdentificationType propertyId  = {.IdSpec = NULL, .IdType = URI};
	ViewEnum view = 0;
	VisibilityEnum visibility = 0;
	OV_UINT mask = 0;
	IdentificationType listId  = {.IdSpec = NULL, .IdType = URI};

	/* PSV */
	OV_STRING pvsName = NULL;

#define GETDATASOURCE() \
		pSubscription = Ov_GetParent(simpleExperimentDataArchiver_HandleData,pinst);\
		if(!pSubscription){\
			state = FAULT;\
			simpleExperimentDataArchiver_writer_errorMsg_set(Ov_DynamicPtrCast(simpleExperimentDataArchiver_writer,pinst),"Connection to Subscription missing");\
			break;\
		}\

	switch (state){
	case SYNC : {
		GETDATASOURCE();

		fb_task_cyctime_set(Ov_DynamicPtrCast(fb_task,pinst),&pSubscription->v_cyctime);
		tmpTS.secs = (OV_UINT) 15/10 * pSubscription->v_cyctime.secs;
		tmpTS.usecs = (OV_UINT) 15/10 * pSubscription->v_cyctime.usecs;
		ov_time_add(&tmpT, & pSubscription->v_proctime, & tmpTS);
		fb_task_proctime_set(Ov_DynamicPtrCast(fb_task,pinst),&tmpT);

		state = PREPAREARCHIVE;
		break;
	}
	case PREPAREARCHIVE : {
		/******* create aas *******
		 * define aasId, aasName, assetId */

		/* find a name for aas. Loop through existing aas until unused name found */
		pAasDomain = ov_path_getobjectpointer("/TechUnits/openAAS/AASFolder",2);
		if(!pAasDomain){
			state = FAULT;
			simpleExperimentDataArchiver_writer_errorMsg_set(Ov_DynamicPtrCast(simpleExperimentDataArchiver_writer,pinst),"cannot find AASFolder");
			break;
		}

		do {
			ov_string_print(&tmpAasName, "Mixture_%u", ++fileIndex);
		} while(NULL != Ov_SearchChildEx(ov_containment, Ov_DynamicPtrCast(ov_domain,pAasDomain) ,tmpAasName , openaas_aas));

		ov_string_print(&aasId.IdSpec,"http://ikv.com/mixingroom/%s_AAS",tmpAasName);
		ov_string_setvalue(&pinst->v_aasId,tmpAasName);

		ov_string_setvalue(&aasName,tmpAasName);

		ov_string_print(&assetId.IdSpec,"http://ikv.com/mixingroom/%s_Asset",tmpAasName);

		aasResult = openaas_modelmanager_createAAS(aasId, aasName, assetId);
		if(aasResult != AASSTATUSCODE_GOOD){
			state = FAULT;
			simpleExperimentDataArchiver_writer_errorMsg_set(Ov_DynamicPtrCast(simpleExperimentDataArchiver_writer,pinst),"creation of AAS failed");
			break;
		}

		/* aas created, free memory */
		ov_string_setvalue(&aasName,NULL);

		/******* create submodel in aas ******
		 * define parentId, modelId */

		ov_string_print(&parentId.IdSpec,"/TechUnits/openAAS/AASFolder/%s.Body",tmpAasName);

		ov_string_print(&modelId.IdSpec,"%s","http://acplt.com/kautschuk/FingerPrint");

		aasResult = openaas_modelmanager_createSubModel(aasId, parentId, modelId, "FingerPrint", 0 ,0);
		if(aasResult != AASSTATUSCODE_GOOD){
			state = FAULT;
			simpleExperimentDataArchiver_writer_errorMsg_set(Ov_DynamicPtrCast(simpleExperimentDataArchiver_writer,pinst),"creation of submodel failed");
			break;
		}

		/* submodel created, free memory */
		ov_string_setvalue(&modelId.IdSpec,NULL);
		ov_string_setvalue(&parentId.IdSpec,NULL);

		/******* create psvl in sm for each subscribed variable ******/
		expressionLogic = MEASUREMENT;
		expressionSemantic = EQUAL;
		view = FUNCTIONAL;
		visibility = PUBLIC;

		/* 0x01:CarrierID;0x02:ExpressionLogic;0x04:ExpressionSemantic;0x08:PropertyID;0x10:View;0x20:Visibility */
		mask = 0x01 | 0x02 | 0x04 | 0x08 | 0x10 | 0x20;

		GETDATASOURCE();
		Ov_ForEachChildEx(simpleExperimentDataArchiver_SubscriptionResult,pSubscription,pVariable,simpleExperimentDataArchiver_Variable){
			ov_string_setvalue(&pvslName,pVariable->v_identifier);
			ov_string_setvalue(&propertyId.IdSpec,pVariable->v_varID);
			ov_string_print(&parentId.IdSpec,"/TechUnits/openAAS/AASFolder/%s.Body/FingerPrint",tmpAasName);
			propertyId.IdType = URI;

			aasResult = openaas_modelmanager_createPVSL(aasId, parentId, pvslName, mask, assetId, expressionLogic, expressionSemantic, propertyId, view, visibility);
			if(aasResult != AASSTATUSCODE_GOOD){
				state = FAULT;
				simpleExperimentDataArchiver_writer_errorMsg_set(Ov_DynamicPtrCast(simpleExperimentDataArchiver_writer,pinst),"creation of PVSL failed");
				break;
			}
		}

		/* free memory */
		ov_string_setvalue(&tmpAasName,NULL);
		ov_string_setvalue(&aasId.IdSpec,NULL);
		ov_string_setvalue(&parentId.IdSpec,NULL);
		ov_string_setvalue(&assetId.IdSpec,NULL);

		/* switch to state waiting */
		pinst->v_timeLastWrite.secs = 0;
		pinst->v_timeLastWrite.usecs = 0;
		state = WAITING;
		break;
	}
	case WAITING : {
		/* wait for start command */
		if(pinst->v_start){
			state = SAVETOFILE;
			pinst->v_start = false;
		}
		break;
	}
	case SAVETOFILE : {
		if(pinst->v_stop){
			state = SYNC;
			pinst->v_stop = false;
		}

		GETDATASOURCE();

		pVariable = Ov_GetFirstChild(simpleExperimentDataArchiver_SubscriptionResult,pSubscription);

		/* timeStamp of first NodeID*/
		timeStamp = simpleExperimentDataArchiver_Variable_varTime_get(pVariable);

		if(ov_time_compare(timeStamp,&pinst->v_timeLastWrite) != OV_TIMECMP_AFTER){ // TODO: check if new data is available
			break;
		}

		pinst->v_timeLastWrite.secs = timeStamp->secs;
		pinst->v_timeLastWrite.usecs = timeStamp->usecs;

		/* use timeStamp as pvs name */
		ov_string_print(&pvsName,"%s; ",ov_time_timetoascii(timeStamp));

		/* get aas Id */
		ov_string_print(&aasId.IdSpec,"http://ikv.com/mixingroom/%s_AAS",pinst->v_aasId);
		aasId.IdType = URI;

		/* get values of all node IDs */
		Ov_ForEachChildEx(simpleExperimentDataArchiver_SubscriptionResult,pSubscription,pVariable,simpleExperimentDataArchiver_Variable){

			ov_string_print(&listId.IdSpec,"/TechUnits/openAAS/AASFolder/%s.Body/FingerPrint/%s",pinst->v_aasId,pVariable->v_identifier);
			aasId.IdType = URI;

			pVariable->v_varValue.time = *timeStamp;

			aasResult = openaas_modelmanager_createPVS(aasId, listId, pvsName, pVariable->v_varValue ,0 , carrierId, expressionLogic, expressionSemantic, propertyId, view, visibility);
			if(aasResult != AASSTATUSCODE_GOOD){
				state = FAULT;
				simpleExperimentDataArchiver_writer_errorMsg_set(Ov_DynamicPtrCast(simpleExperimentDataArchiver_writer,pinst),"creation of PVS failed");
				break;
			}
			/* free memory */
			ov_string_setvalue(&listId.IdSpec,NULL);
		}
		/* free memory */
		ov_string_setvalue(&aasId.IdSpec,NULL);
		break;
	}
	case CLEANUP : {
		break;
	}
	case FAULT : {
		if(pinst->v_reset){
			state = SYNC;
			ov_string_setvalue(&pinst->v_errorMsg,"");
			pinst->v_reset = FALSE;
		}
		break;
	}
	default: {
		state = FAULT;
		break;
	}
	}

	simpleExperimentDataArchiver_writer_state_set(Ov_DynamicPtrCast(simpleExperimentDataArchiver_writer,pinst),state);
	return;
}

