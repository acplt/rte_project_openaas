
/******************************************************************************
*
*   FILE
*   ----
*   AASComponentManager.c
*
*   History
*   -------
*   2017-05-16   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_openaas
#define OV_COMPILE_LIBRARY_openaas
#endif


#include "openaas.h"
#include "libov/ov_macros.h"
#include "openaas_helpers.h"
#include "jsonparsing.h"
#include "fb_database.h"
#include "MessageSys_helpers.h"

extern OV_INSTPTR_openaas_InterfaceDiscoveryServer pInterfaceDiscoveryServer;
static OV_INT LOCALMSGCOUNTER;

OV_DLLFNCEXPORT OV_RESULT openaas_AASComponentManager_reset_set(
    OV_INSTPTR_openaas_AASComponentManager          pobj,
    const OV_BOOL  value
) {
	if (value == TRUE){
		pobj->v_state = 0;
	}
    pobj->v_reset = value;
    return OV_ERR_OK;
}



OV_DLLFNCEXPORT OV_RESULT openaas_AASComponentManager_constructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*
    *   local variables
    */
    OV_INSTPTR_openaas_AASComponentManager pinst = Ov_StaticPtrCast(openaas_AASComponentManager, pobj);
    OV_RESULT    result;

    /* do what the base class does first */
    result = fb_functionblock_constructor(pobj);
    if(Ov_Fail(result))
         return result;

    /* do what */
    if (!Ov_CanCastTo(openaas_aas, pinst->v_pouterobject)){
		ov_logfile_error("Can not created without an parent AAS");
		return OV_ERR_BADPATH;
	}

    pinst->v_iexreq = TRUE;
    pinst->v_actimode = 1;
    OV_INSTPTR_fb_task pTaskParent = NULL;
    pinst->v_messageBoxIsFiFo = TRUE;
    pinst->v_messageBoxSize = 10;
    pinst->v_state = 0;
    pinst->v_messageTimeOut.secs = 5;
    pinst->v_messageTimeOut.usecs = 0;
    pTaskParent = (OV_INSTPTR_fb_task)fb_database_geturtask();
    if (pTaskParent != NULL){
    	Ov_Link(fb_tasklist, pTaskParent, pinst);
    }
    else {
    	ov_logfile_error("Cannot link StateMachine to tasklist", pinst->v_identifier);
    }

    return OV_ERR_OK;
}


OV_DLLFNCEXPORT OV_ACCESS openaas_AASComponentManager_getaccess(
	OV_INSTPTR_ov_object	pobj,
	const OV_ELEMENT		*pelem,
	const OV_TICKET			*pticket
) {
    /*    
    *   local variables
    */
	return (OV_ACCESS)OV_AC_WRITE | OV_AC_READ | OV_AC_LINKABLE | OV_AC_UNLINKABLE | OV_AC_DELETEABLE | OV_AC_RENAMEABLE;
}


static OV_INSTPTR_MessageSys_Message getNextMessage(OV_INSTPTR_openaas_AASComponentManager this) {
	OV_INSTPTR_ov_object child = NULL;

	//Check if we have a Message if(FiFo) else(Stack)
	if (this->v_messageBoxIsFiFo == TRUE) {
		// Get the first child that can be casted to Message.
		child = Ov_GetFirstChild(ov_containment, &this->p_INBOX);
		while (child && !Ov_CanCastTo(MessageSys_Message , child)) {
			child = Ov_GetNextChild(ov_containment, child);
		}
	} else {
		// Get the last child that can be casted to Message.
		child = Ov_GetLastChild(ov_containment, &this->p_INBOX);
		while (child && !Ov_CanCastTo(MessageSys_Message , child)) {
			child = Ov_GetPreviousChild(ov_containment, child);
		}
	}
	return (OV_INSTPTR_MessageSys_Message) child;
}

static void cleanupMessageBox(OV_INSTPTR_openaas_AASComponentManager this) {
	int nMessagesToDelete = 0;
	int nMessagesDeleted = 0;
	OV_INSTPTR_ov_object pChild = NULL;
	OV_INSTPTR_MessageSys_Message pMessageToDelete = NULL;

	// Calculate the number of messages to delete.
	Ov_ForEachChild(ov_containment, &this->p_INBOX, pChild) {
		if (Ov_CanCastTo(MessageSys_Message, pChild)) {
			nMessagesToDelete++;
		}
	}
	nMessagesToDelete = nMessagesToDelete - this->v_messageBoxSize;

	// Delete the messages.
	// TODO: To be optimized.
	while (nMessagesDeleted < nMessagesToDelete) {
		// Find a message to delete.
		pMessageToDelete = NULL;
		Ov_ForEachChild(ov_containment, &this->p_INBOX, pChild) {
			if (!Ov_CanCastTo(MessageSys_Message, pChild)) {
				continue;
			}
			if (this->v_messageBoxIsFiFo) {
				if (pMessageToDelete == NULL || ov_time_compare(&pMessageToDelete->v_creationtime, &pChild->v_creationtime) == OV_TIMECMP_AFTER) {
					pMessageToDelete = (OV_INSTPTR_MessageSys_Message) pChild;
				}
			} else {
				if (pMessageToDelete == NULL || ov_time_compare(&pMessageToDelete->v_creationtime, &pChild->v_creationtime) == OV_TIMECMP_BEFORE) {
					pMessageToDelete = (OV_INSTPTR_MessageSys_Message) pChild;
				}
			}
		}
		// Delete the message.
		Ov_DeleteObject(pMessageToDelete);
		nMessagesDeleted++;
	}
	return;
}

// RequestType:
// 0:RegisterAAS
// 1:UnregisterAAS
// 2:GetAAS
static OV_STRING sendingRequestToDiscoveryServer(OV_INSTPTR_openaas_AASComponentManager this, OV_UINT requestType, IdentificationType requestedAASId) {
	OV_INSTPTR_openaas_aas paas;
	OV_STRING tempString = NULL;
	OV_RESULT resultOV = OV_ERR_OK;
	OV_INSTPTR_MessageSys_Message pRequestMessage = NULL;
	OV_INSTPTR_MessageSys_MsgDelivery pmsgDelivery = NULL;
	OV_INSTPTR_propertyValueStatement_CarrierId pCarrierId = NULL;
	OV_INSTPTR_ov_object pchild = NULL;
	// Create MessageObject in Outbox
	paas = Ov_StaticPtrCast(openaas_aas,this->v_pouterobject);
	ov_string_setvalue(&tempString, NULL);
	ov_string_setvalue(&tempString, "Request");
	resultOV = Ov_CreateObject(MessageSys_Message, pRequestMessage, &this->p_OUTBOX, tempString);
	ov_string_setvalue(&tempString, NULL);
	if(Ov_Fail(resultOV)){
		ov_logfile_error("Could not create an request Message. Reason: %s", ov_result_getresulttext(resultOV));
		return NULL;
	}

	// Sender = this AASComponentManager
	if (pInterfaceDiscoveryServer == NULL){
		Ov_DeleteObject((OV_INSTPTR_ov_object) pRequestMessage);
		ov_logfile_error("Could not find InterfaceDiscoveryServer");
		return NULL;
	}
	MessageSys_Message_senderAddress_set(pRequestMessage, pInterfaceDiscoveryServer->v_IPAddressServer);

	// ServerName
	OV_STRING servername = NULL;
	OV_ANY srvnameprops;
	ov_vendortree_getservername(&srvnameprops, NULL);
	ov_string_setvalue(&servername,srvnameprops.value.valueunion.val_string);
	MessageSys_Message_senderName_set(pRequestMessage,servername);
	ov_string_setvalue(&servername, NULL);

	// Path
	ov_memstack_lock();
	MessageSys_Message_senderComponent_set(pRequestMessage, ov_path_getcanonicalpath(Ov_PtrUpCast(ov_object,this), 2));
	ov_memstack_unlock();

	// Receiver = DiscoveryServer
	MessageSys_Message_receiverAddress_set(pRequestMessage, pInterfaceDiscoveryServer->v_IPAddressAASDiscoveryServer);
	MessageSys_Message_receiverName_set(pRequestMessage, pInterfaceDiscoveryServer->v_ManagerNameAASDiscoveryServer);
	ov_string_setvalue(&tempString, pInterfaceDiscoveryServer->v_PathToAASDiscoveryServer);
	ov_string_append(&tempString, ".ComponentManager");
	MessageSys_Message_receiverComponent_set(pRequestMessage, tempString);
	ov_string_setvalue(&tempString, NULL);

	// Body
	// XML Encoding
	OV_STRING answerBody = NULL;
	ov_string_setvalue(&answerBody, "<bdy>");
	switch(requestType){
	case 0:
		ov_string_append(&answerBody, "RegisterAASReq:");
		Ov_ForEachChild(ov_containment, &paas->p_Header.p_Config, pchild){
			if (Ov_CanCastTo(propertyValueStatement_CarrierId, pchild)){
				pCarrierId = Ov_DynamicPtrCast(propertyValueStatement_CarrierId, pchild);
				ov_string_append(&answerBody, pCarrierId->v_IdSpec);
				ov_string_append(&answerBody, ",");
				ov_string_print(&tempString, "%i", pCarrierId->v_IdType);
				ov_string_append(&answerBody, tempString);
				break;
			}
		}
		ov_string_setvalue(&tempString, NULL);
		ov_string_append(&answerBody, ",");
		ov_string_append(&answerBody, pRequestMessage->v_senderAddress);
		ov_string_append(&answerBody, ",");
		ov_string_append(&answerBody, pRequestMessage->v_senderName);
		ov_string_append(&answerBody, ",");
		ov_string_append(&answerBody, pRequestMessage->v_senderComponent);
		break;
	case 1:
		ov_string_append(&answerBody, "UnregisterAASReq:");
		Ov_ForEachChild(ov_containment, &paas->p_Header.p_Config, pchild){
			if (Ov_CanCastTo(propertyValueStatement_CarrierId, pchild)){
				pCarrierId = Ov_DynamicPtrCast(propertyValueStatement_CarrierId, pchild);
				ov_string_append(&answerBody, pCarrierId->v_IdSpec);
				ov_string_append(&answerBody, ",");
				ov_string_print(&tempString, "%i", pCarrierId->v_IdType);
				ov_string_append(&answerBody, tempString);
				break;
			}
		}
		ov_string_setvalue(&tempString, NULL);
		break;
	case 2:
		ov_string_append(&answerBody, "GetAASReq:");
		ov_string_append(&answerBody, requestedAASId.IdSpec);
		ov_string_append(&answerBody, ",");
		ov_string_print(&tempString, "%i", requestedAASId.IdType);
		ov_string_append(&answerBody, tempString);
		ov_string_setvalue(&tempString, NULL);
		break;
	default:
		Ov_DeleteObject((OV_INSTPTR_ov_object) pRequestMessage);
		ov_logfile_error("requestType not supported");
		ov_string_setvalue(&answerBody, NULL);
		return NULL;
		break;
	}
	ov_string_append(&answerBody, "</bdy>");
	ov_string_setvalue(&pRequestMessage->v_msgBody, answerBody);
	ov_string_setvalue(&answerBody, NULL);

	// Message ready for sending
	pRequestMessage->v_msgStatus = MSGREADYFORSENDING;

	// Search for MsgDelivery object
	Ov_ForEachChildEx(ov_instantiation, pclass_MessageSys_MsgDelivery, pmsgDelivery, MessageSys_MsgDelivery){
		if(ov_string_compare(pmsgDelivery->v_identifier, "MessageSys") == OV_STRCMP_EQUAL){
			break;
		}
	}
	if (!pmsgDelivery){
		Ov_DeleteObject((OV_INSTPTR_ov_object) pRequestMessage);
		ov_logfile_error("Could not find MessageSys");
		return NULL;
	}

	// send Message
	if (MessageSys_MsgDelivery_sendMessage(pmsgDelivery, pRequestMessage) == FALSE){
		Ov_DeleteObject((OV_INSTPTR_ov_object) pRequestMessage);
		ov_logfile_error("Could not send Message");
		return NULL;
	}

	// MsgId
	return MessageSys_Message_msgID_get(pRequestMessage);
}




OV_DLLFNCEXPORT void openaas_AASComponentManager_typemethod(
	OV_INSTPTR_fb_functionblock	pfb,
	OV_TIME						*pltc
) {
    /*    
    *   local variables
    */

	OV_INSTPTR_openaas_AASComponentManager pinst = Ov_StaticPtrCast(openaas_AASComponentManager, pfb);
	OV_RESULT resultOV = OV_ERR_OK;
	AASStatusCode result = AASSTATUSCODE_GOOD;
	OV_INSTPTR_MessageSys_Message message = NULL;
	OV_STRING tempString = NULL;
	OV_INSTPTR_MessageSys_Message answerMessage = NULL;
	OV_INSTPTR_MessageSys_MsgDelivery pmsgDelivery = NULL;
	OV_INSTPTR_openaas_aas paas;
	OV_STRING messageContent = NULL;
	OV_UINT messageLength = 0;
	OV_UINT len = 0;
	OV_STRING *plistReq = NULL;
	OV_INSTPTR_fb_task pTaskParent = NULL;
	OV_TIME_SPAN tmpTimeSpan;
	OV_INSTPTR_ov_object pchild = NULL;
	OV_INSTPTR_propertyValueStatement_CarrierId pCarrierId = NULL;

	// First clean message box, so only up-to-date messages are handled.
	cleanupMessageBox(pinst);

	// StateMaschine
	switch(pinst->v_state){
	case 0: //Waiting for the setting of AASID
		pinst->v_messageCount = 0;
		pinst->v_registered = FALSE;
		IdentificationType tmpAASId;
		IdentificationType_init(&tmpAASId);

		paas = Ov_StaticPtrCast(openaas_aas,pinst->v_pouterobject);
		if(!getAASIdbyObjectPointer(paas,&tmpAASId)){
			goto clean_state_0;
		}
		if(ov_string_compare(tmpAASId.IdSpec,"")==OV_STRCMP_EQUAL){
			goto clean_state_0;
		}
		//register AAS
		sendingRequestToDiscoveryServer(pinst, 0, tmpAASId);
		IdentificationType_deleteMembers(&tmpAASId);
		pinst->v_state = 1;


		clean_state_0:
		IdentificationType_deleteMembers(&tmpAASId);

		break;
	case 1: //Sending Register-Request and wait for answer
		// Get the next message, if any.
		pinst->v_messageCount++;
		pTaskParent=Ov_GetParent(fb_tasklist, pinst);
		tmpTimeSpan.usecs = pTaskParent->v_cyctime.usecs * pinst->v_messageCount;
		tmpTimeSpan.secs = pTaskParent->v_cyctime.secs * pinst->v_messageCount;
		if((OV_INT)tmpTimeSpan.usecs > 999999) {
			tmpTimeSpan.usecs -= 1000000;
			tmpTimeSpan.secs++;
			return;
		}
		if (tmpTimeSpan.secs > pinst->v_messageTimeOut.secs || (tmpTimeSpan.secs == pinst->v_messageTimeOut.secs && tmpTimeSpan.usecs > pinst->v_messageTimeOut.usecs)){
			pinst->v_messageCount = 0;
			IdentificationType tmpAASId;
			IdentificationType_init(&tmpAASId);
			sendingRequestToDiscoveryServer(pinst, 0, tmpAASId);
			IdentificationType_deleteMembers(&tmpAASId);
		}
		message = getNextMessage(pinst);
		if (message == NULL) {
			// Nothing to do.
			return;
		}
		// Decoding the Message
		// XML Decoding
		if (strncmp(message->v_msgBody, "<bdy>", 5) != 0){ // <bdy> not found
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: <bdy> not found in msg. Reason");
			return;
		}
		messageLength = ov_string_getlength(message->v_msgBody);
		if (strncmp(&message->v_msgBody[messageLength-6], "</bdy>", 6) != 0){ // </bdy> not found
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: </bdy> not found in msg. Reason");
			return;
		}
		messageContent = malloc((messageLength-11+1)*sizeof(char));
		memcpy(messageContent, (message->v_msgBody+5), messageLength-11);
		messageContent[messageLength-11] = '\0';

		plistReq= ov_string_split(messageContent, ":", &len);
		free (messageContent);
		if (ov_string_compare(plistReq[0], "RegisterAASRes") == OV_STRCMP_EQUAL){ // register response
			if (ov_string_compare(plistReq[1], "OK") == OV_STRCMP_EQUAL){ // register was successfully
				pinst->v_state = 2;
				pTaskParent=Ov_GetParent(fb_tasklist, pinst);
				if(pTaskParent->v_cyctime.secs > 0)
					pinst->v_messageCount = pinst->v_messageTimeOut.secs / pTaskParent->v_cyctime.secs;
				else
					pinst->v_messageCount = pinst->v_messageTimeOut.usecs / pTaskParent->v_cyctime.usecs;
				pinst->v_registered = TRUE;
			}else{ // Error
				ov_string_setvalue(&pinst->v_errorText, plistReq[1]);
				pinst->v_state = 6;
			}
		}else{ // no register response => delete message and wait for next one
		}
		Ov_DeleteObject((OV_INSTPTR_ov_object) message);
		ov_string_freelist(plistReq);
		break;
	case 2: //Process incoming messages
		// Get the next message, if any.
		message = getNextMessage(pinst);
		if (message == NULL) {
			// Nothing to do.
			return;
		}

		// Decoding the Message
		// XML Decoding
		if (strncmp(message->v_msgBody, "<bdy>", 5) != 0){ // <bdy> not found
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: <bdy> not found in msg. Reason");
			return;
		}
		messageLength = ov_string_getlength(message->v_msgBody);
		if (strncmp(&message->v_msgBody[messageLength-6], "</bdy>", 6) != 0){ // </bdy> not found
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: </bdy> not found in msg. Reason");
			return;
		}
		messageContent = malloc((messageLength-11+1)*sizeof(char));
		memcpy(messageContent, (message->v_msgBody+5), messageLength-11);
		messageContent[messageLength-11] = '\0';

		// JSON Decoding
		SRV_String *srvStringReceive = SRV_String_new();
		SRV_String_setCopy(srvStringReceive, messageContent, messageLength-11+1);
		free(messageContent);
		SRV_msgHeader *headerReceive = NULL;
		void *srvStructReceive = NULL;
		SRV_service_t srvTypeReceive;
		SRV_encoding_t encoding;
		resultOV = decodeMSG(srvStringReceive, &headerReceive, &srvStructReceive, &srvTypeReceive, &encoding);
		if (resultOV){
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: JSON Decoding message failed. Reason: %s", ov_result_getresulttext(resultOV));
			SRV_serviceGeneric_delete(srvStructReceive, srvTypeReceive);
			SRV_msgHeader_t_delete(headerReceive);
			SRV_String_delete(srvStringReceive);
			return;
		}

		// For encoding the message
		SRV_String *srvStringSend = NULL;
		SRV_msgHeader *headerSend = NULL;
		void *srvStructSend = NULL;
		SRV_service_t srvTypeSend;

		//Check if the parent is an AAS
		paas = Ov_StaticPtrCast(openaas_aas,pinst->v_pouterobject);
		IdentificationType aasId;
		IdentificationType_init(&aasId);
		Ov_ForEachChild(ov_containment, &paas->p_Header.p_Config, pchild){
			if (Ov_CanCastTo(propertyValueStatement_CarrierId, pchild)){
				pCarrierId = Ov_DynamicPtrCast(propertyValueStatement_CarrierId, pchild);
				ov_string_setvalue(&aasId.IdSpec, pCarrierId->v_IdSpec);
				aasId.IdType = pCarrierId->v_IdType;
				break;
			}
		}

		IdentificationType receiver;
		IdentificationType_init(&receiver);
		ov_string_setvalue(&receiver.IdSpec, headerReceive->receiver.idSpec.data);
		receiver.IdType = headerReceive->receiver.idType;
		OV_BOOL sendAnswer = FALSE;

		if (getAASIdbyObjectPointer(paas,&aasId) && IdentificationTypeEqual(&receiver, &aasId)){ // MSG is for this AAS
			headerSend = SRV_msgHeader_t_reverseCopy(headerReceive);
			switch (srvTypeReceive){
			case SRV_createAASReq:{
				if (ov_string_compare(paas->v_identifier, "ComCo") == OV_STRCMP_EQUAL){ // This AAS is the ComCo
					createAASReq_t *createAASReq = (createAASReq_t*)srvStructReceive;

					IdentificationType tmpOVAASId;
					IdentificationType_init(&tmpOVAASId);
					ov_string_setvalue(&tmpOVAASId.IdSpec, createAASReq->aasId.idSpec.data);
					tmpOVAASId.IdType = createAASReq->aasId.idType;

					OV_STRING tmpOVName = NULL;
					ov_string_setvalue(&tmpOVName, createAASReq->aasName.data);

					IdentificationType tmpOVAssetId;
					IdentificationType_init(&tmpOVAssetId);
					ov_string_setvalue(&tmpOVAssetId.IdSpec, createAASReq->assetId.idSpec.data);
					tmpOVAssetId.IdType = createAASReq->assetId.idType;

					//result = openaas_modelmanager_createAAS(tmpOVAASId, tmpOVName, tmpOVAssetId);

					createAASRsp_t createAASRsp;
					createAASRsp_t_init(&createAASRsp);

					createAASRsp.status = result;

					srvStructSend = &createAASRsp;
					srvTypeSend = SRV_createAASRsp;

					resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

					createAASRsp_t_deleteMembers(&createAASRsp);
					IdentificationType_deleteMembers(&tmpOVAASId);
					IdentificationType_deleteMembers(&tmpOVAssetId);
					ov_database_free(tmpOVName);
				}else{
					createAASRsp_t createAASRsp;
					createAASRsp_t_init(&createAASRsp);

					createAASRsp.status = AASSTATUSCODE_BADAASID;

					srvStructSend = &createAASRsp;
					srvTypeSend = SRV_createAASRsp;

					resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

					createAASRsp_t_deleteMembers(&createAASRsp);
				}
				sendAnswer = TRUE;
			}break;
			case SRV_createAASRsp:{
				// TODO: Check the answer
			}break;
			case SRV_deleteAASReq:{
				if (ov_string_compare(paas->v_identifier, "ComCo") == OV_STRCMP_EQUAL){ // This AAS is the ComCo
					deleteAASReq_t *deleteAASReq = (deleteAASReq_t*)srvStructReceive;

					IdentificationType tmpOVAASId;
					IdentificationType_init(&tmpOVAASId);
					ov_string_setvalue(&tmpOVAASId.IdSpec, deleteAASReq->aasId.idSpec.data);
					tmpOVAASId.IdType = deleteAASReq->aasId.idType;


					//result = openaas_modelmanager_deleteAAS(tmpOVAASId);

					deleteAASRsp_t deleteAASRsp;
					deleteAASRsp_t_init(&deleteAASRsp);

					deleteAASRsp.status = result;

					srvStructSend = &deleteAASRsp;
					srvTypeSend = SRV_deleteAASRsp;

					resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

					deleteAASRsp_t_deleteMembers(&deleteAASRsp);
					IdentificationType_deleteMembers(&tmpOVAASId);
				}else{
					deleteAASRsp_t deleteAASRsp;
					deleteAASRsp_t_init(&deleteAASRsp);

					deleteAASRsp.status = AASSTATUSCODE_BADAASID;

					srvStructSend = &deleteAASRsp;
					srvTypeSend = SRV_deleteAASRsp;

					resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

					deleteAASRsp_t_deleteMembers(&deleteAASRsp);
				}
				sendAnswer = TRUE;
			}break;
			case SRV_deleteAASRsp:{
				// TODO: Check the answer
			}break;
			case SRV_createPVSLReq:{
				createPVSLReq_t *createPVSLReq = (createPVSLReq_t*)srvStructReceive;

				IdentificationType tmpOVSubModelId;
				IdentificationType_init(&tmpOVSubModelId);
				ov_string_setvalue(&tmpOVSubModelId.IdSpec, createPVSLReq->subModelId.idSpec.data);
				tmpOVSubModelId.IdType = createPVSLReq->subModelId.idType;

				OV_STRING tmpOVPVSLName = NULL;
				ov_string_setvalue(&tmpOVPVSLName, createPVSLReq->pvslName.data);

				IdentificationType tmpOVCarrier;
				IdentificationType_init(&tmpOVCarrier);
				ov_string_setvalue(&tmpOVCarrier.IdSpec, createPVSLReq->carrier.idSpec.data);
				tmpOVCarrier.IdType = createPVSLReq->carrier.idType;

				IdentificationType tmpOVCreatingInstance;
				IdentificationType_init(&tmpOVCreatingInstance);
				ov_string_setvalue(&tmpOVCreatingInstance.IdSpec, createPVSLReq->carrier.idSpec.data);
				tmpOVCreatingInstance.IdType = createPVSLReq->carrier.idType;

				//result = openaas_modelmanager_createPVSL(aasId, tmpOVSubModelId, tmpOVPVSLName, tmpOVCarrier, tmpOVCreatingInstance);

				createPVSLRsp_t createPVSLRsp;
				createPVSLRsp_t_init(&createPVSLRsp);

				createPVSLRsp.status = result;

				srvStructSend = &createPVSLRsp;
				srvTypeSend = SRV_createPVSLRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				createPVSLRsp_t_deleteMembers(&createPVSLRsp);
				IdentificationType_deleteMembers(&tmpOVCarrier);
				IdentificationType_deleteMembers(&tmpOVCreatingInstance);
				ov_database_free(tmpOVPVSLName);
				sendAnswer = TRUE;
			}break;
			case SRV_createPVSLRsp:{
				// TODO: Check the answer
			}break;
			case SRV_deletePVSLReq:{
				deletePVSLReq_t *deletePVSLReq = (deletePVSLReq_t*)srvStructReceive;

				IdentificationType tmpOVSubModelId;
				IdentificationType_init(&tmpOVSubModelId);
				ov_string_setvalue(&tmpOVSubModelId.IdSpec, deletePVSLReq->subModelId.idSpec.data);
				tmpOVSubModelId.IdType = deletePVSLReq->subModelId.idType;

				OV_STRING tmpOVPVSLName = NULL;
				ov_string_setvalue(&tmpOVPVSLName, deletePVSLReq->pvslName.data);

				//result = openaas_modelmanager_deletePVSL(aasId, tmpOVSubModelId, tmpOVPVSLName);

				deletePVSLRsp_t deletePVSLRsp;
				deletePVSLRsp_t_init(&deletePVSLRsp);

				deletePVSLRsp.status = result;

				srvStructSend = &deletePVSLRsp;
				srvTypeSend = SRV_deletePVSLRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				deletePVSLRsp_t_deleteMembers(&deletePVSLRsp);
				ov_database_free(tmpOVPVSLName);
				sendAnswer = TRUE;
			}break;
			case SRV_deletePVSLRsp:{
				// TODO: Check the answer
			}break;
			case SRV_createPVSReq:{
				createPVSReq_t *createPVSReq = (createPVSReq_t*)srvStructReceive;

				IdentificationType tmpOVSubModelId;
				IdentificationType_init(&tmpOVSubModelId);
				ov_string_setvalue(&tmpOVSubModelId.IdSpec, createPVSReq->subModelId.idSpec.data);
				tmpOVSubModelId.IdType = createPVSReq->subModelId.idType;

				OV_STRING tmpOVPVSLName = NULL;
				ov_string_setvalue(&tmpOVPVSLName, createPVSReq->pvslName.data);

				PropertyValueStatement pvs;
				PropertyValueStatement_init(&pvs);

				ov_string_setvalue(&pvs.pvsName, createPVSReq->pvs.name.data);

				pvs.ExpressionLogic = createPVSReq->pvs.expressionSemantic;

				pvs.ExpressionSemantic = createPVSReq->pvs.expressionSemantic;

				serviceValueToOVDataValue(&pvs.value, createPVSReq->pvs.valType, createPVSReq->pvs.value, 0);

				ov_string_setvalue(&pvs.unit, createPVSReq->pvs.unit.data);

				ov_string_setvalue(&pvs.ID.IdSpec, createPVSReq->pvs.ID.idSpec.data);
				pvs.ID.IdType = createPVSReq->pvs.ID.idType;

				pvs.view = createPVSReq->pvs.view;

				pvs.Visibility = createPVSReq->pvs.visibility;

				//result = openaas_modelmanager_createPVS(aasId, tmpOVSubModelId, tmpOVPVSLName, pvs);

				createPVSRsp_t createPVSRsp;
				createPVSRsp_t_init(&createPVSRsp);

				createPVSRsp.status = result;

				srvStructSend = &createPVSRsp;
				srvTypeSend = SRV_createPVSRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				createPVSRsp_t_deleteMembers(&createPVSRsp);
				ov_database_free(tmpOVPVSLName);
				PropertyValueStatement_deleteMembers(&pvs);
				sendAnswer = TRUE;
			}break;
			case SRV_createPVSRsp:{
				// TODO: Check the answer
			}break;
			case SRV_deletePVSReq:{
				deletePVSReq_t *deletePVSReq = (deletePVSReq_t*)srvStructReceive;

				IdentificationType tmpOVSubModelId;
				IdentificationType_init(&tmpOVSubModelId);
				ov_string_setvalue(&tmpOVSubModelId.IdSpec, deletePVSReq->subModelId.idSpec.data);
				tmpOVSubModelId.IdType = deletePVSReq->subModelId.idType;

				OV_STRING tmpOVPVSLName = NULL;
				ov_string_setvalue(&tmpOVPVSLName, deletePVSReq->pvslName.data);

				OV_STRING tmpOVPVSName = NULL;
				ov_string_setvalue(&tmpOVPVSName, deletePVSReq->pvsName.data);

				//result = openaas_modelmanager_deletePVS(aasId, tmpOVSubModelId, tmpOVPVSLName, tmpOVPVSName);

				deletePVSRsp_t deletePVSRsp;
				deletePVSRsp_t_init(&deletePVSRsp);

				deletePVSRsp.status = result;

				srvStructSend = &deletePVSRsp;
				srvTypeSend = SRV_deletePVSRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				deletePVSRsp_t_deleteMembers(&deletePVSRsp);
				ov_database_free(tmpOVPVSLName);
				ov_database_free(tmpOVPVSName);
				sendAnswer = TRUE;
			}break;
			case SRV_deletePVSRsp:{
				// TODO: Check the answer
			}break;
			case SRV_setPVSReq:{
				setPVSReq_t *setPVSReq = (setPVSReq_t*)srvStructReceive;

				//IdentificationType tmpOVSubModelId;
				//IdentificationType_init(&tmpOVSubModelId);
				//ov_string_setvalue(&tmpOVSubModelId.IdSpec, setPVSReq->subModelId.idSpec.data);
				//tmpOVSubModelId.IdType = setPVSReq->subModelId.idType;

				OV_STRING tmpOVPVSLName = NULL;
				ov_string_setvalue(&tmpOVPVSLName, setPVSReq->pvslName.data);


				PropertyValueStatement pvs;
				PropertyValueStatement_init(&pvs);


				ov_string_setvalue(&pvs.pvsName, setPVSReq->pvs.name.data);

				pvs.ExpressionLogic = setPVSReq->pvs.expressionLogic;

				pvs.ExpressionSemantic = setPVSReq->pvs.expressionSemantic;

				serviceValueToOVDataValue(&pvs.value, setPVSReq->pvs.valType, setPVSReq->pvs.value, 0);

				ov_string_setvalue(&pvs.unit, setPVSReq->pvs.unit.data);

				ov_string_setvalue(&pvs.ID.IdSpec, setPVSReq->pvs.ID.idSpec.data);

				pvs.ID.IdType = setPVSReq->pvs.ID.idType;

				pvs.view = setPVSReq->pvs.view;

				pvs.Visibility = setPVSReq->pvs.visibility;

				IdentificationType carrierId;
				IdentificationType_init(&carrierId);
				int len = 0;
				ov_string_setvalue(&pvs.objectID.IdSpec, setPVSReq->pvs.objectID.idSpec.data);
				//remove "http://acplt.org"-prefix from id, to use the string as path
				OV_STRING *idStr = ov_string_split(pvs.objectID.IdSpec,"http://acplt.org",&len);
				if(!idStr || len<2 || !idStr[1])
					goto clean_SRV_setPVSReq;

				ov_string_setvalue(&pvs.objectID.IdSpec,idStr[1]);

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				pvs.objectID.IdType = setPVSReq->pvs.objectID.idType;
				openaas_modelmanager_setPVS(aasId,
						pvs.objectID,
						setPVSReq->pvs.mask,
						pvs.pvsName,
						carrierId,
						setPVSReq->pvs.expressionLogic,setPVSReq->pvs.expressionSemantic,
						pvs.ID,
						setPVSReq->pvs.view,
						setPVSReq->pvs.visibility,pvs.value);
				//openaas_modelmanager_setPVS(aasId,pvs.pvsName)
				//result = openaas_modelmanager_createPVS(aasId, tmpOVSubModelId, tmpOVPVSLName, pvs);

				setPVSRsp_t setPVSRsp;
				setPVSRsp_t_init(&setPVSRsp);

				setPVSRsp.status = result;

				srvStructSend = &setPVSRsp;
				srvTypeSend = SRV_setPVSRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);
				//setPVSRsp_t_deleteMembers(&setPVSRsp);
				clean_SRV_setPVSReq:
					ov_database_free(tmpOVPVSLName);
					PropertyValueStatement_deleteMembers(&pvs);
				sendAnswer = FALSE;
			}break;
			case SRV_setPVSRsp:{
				// TODO: Check the answer
			}break;
			case SRV_getPVSReq:{
				getPVSReq_t *getPVSReq = (getPVSReq_t*)srvStructReceive;

				IdentificationType tmpOVSubModelId;
				IdentificationType_init(&tmpOVSubModelId);
				ov_string_setvalue(&tmpOVSubModelId.IdSpec, getPVSReq->subModelId.idSpec.data);
				tmpOVSubModelId.IdType = getPVSReq->subModelId.idType;

				OV_STRING tmpOVPVSLName = NULL;
				ov_string_setvalue(&tmpOVPVSLName, getPVSReq->pvslName.data);

				OV_STRING tmpOVPVSName = NULL;
				ov_string_setvalue(&tmpOVPVSName, getPVSReq->pvsName.data);

				PropertyValueStatement pvs;
				PropertyValueStatement_init(&pvs);

				//result = openaas_modelmanager_getPVS(aasId, tmpOVSubModelId, tmpOVPVSLName, tmpOVPVSName, &pvs);

				getPVSRsp_t getPVSRsp;
				getPVSRsp_t_init(&getPVSRsp);

				getPVSRsp.pvs.expressionLogic = pvs.ExpressionLogic;

				getPVSRsp.pvs.expressionSemantic = pvs.ExpressionSemantic;

				OVDataValueToserviceValue(pvs.value, &getPVSRsp.pvs.valType, &getPVSRsp.pvs.value, &getPVSRsp.pvs.valTime);

				ov_string_setvalue(&getPVSRsp.pvs.unit.data, pvs.unit);
				getPVSRsp.pvs.hasUnit = TRUE;

				ov_string_setvalue(&getPVSRsp.pvs.ID.idSpec.data, pvs.ID.IdSpec);
				getPVSRsp.pvs.ID.idType = pvs.ID.IdType;

				getPVSRsp.pvs.view = pvs.view;

				getPVSRsp.pvs.visibility = pvs.Visibility;

				getPVSRsp.status = result;

				srvStructSend = &getPVSRsp;
				srvTypeSend = SRV_getPVSRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				getPVSRsp_t_deleteMembers(&getPVSRsp);
				ov_database_free(tmpOVPVSLName);
				ov_database_free(tmpOVPVSName);
				PropertyValueStatement_deleteMembers(&pvs);
				sendAnswer = TRUE;
			}break;
			case SRV_getPVSRsp:{
				// TODO: Check the answer
			}break;
			case SRV_getCoreDataReq:{
				OV_UINT tmpNumber = 0;

				PropertyValueStatementList *ppvs = NULL;

				//result = openaas_modelmanager_getCoreData(aasId, &tmpNumber, &ppvs);
				ov_logfile_debug("Anzahl: %i", tmpNumber);
				free(messageContent);
				getCoreDataRsp_t getCoreDataRsp;
				getCoreDataRsp_t_init(&getCoreDataRsp);

				getCoreDataRsp.status = result;
				if (!result){
					getCoreDataRsp.numPvsl = tmpNumber;
					getCoreDataRsp.pvsl = malloc(sizeof(PVSL_t)*tmpNumber);
					for (OV_UINT i = 0; i < tmpNumber; i++){
						SRV_String_setCopy(&getCoreDataRsp.pvsl[i].carrier.idSpec, ppvs[i].Carrier.IdSpec, ov_string_getlength(ppvs[i].Carrier.IdSpec));
						getCoreDataRsp.pvsl[i].carrier.idType = ppvs[i].Carrier.IdType;
						SRV_String_setCopy(&getCoreDataRsp.pvsl[i].creatingInstance.idSpec, ppvs[i].CreatingInstance.IdSpec, ov_string_getlength(ppvs[i].CreatingInstance.IdSpec));
						getCoreDataRsp.pvsl[i].creatingInstance.idType = ppvs[i].CreatingInstance.IdType;
						getCoreDataRsp.pvsl[i].creationTime = ov_ovTimeTo1601nsTime(ppvs[i].CreationTime);
						getCoreDataRsp.pvsl[i].hasCreationTime = TRUE;
						SRV_String_setCopy(&getCoreDataRsp.pvsl[i].name, ppvs[i].pvslName, ov_string_getlength(ppvs[i].pvslName));
						getCoreDataRsp.pvsl[i].hasName = TRUE;
						getCoreDataRsp.pvsl[i].numPvs = ppvs[i].pvsNumber;
						getCoreDataRsp.pvsl[i].pvs = malloc(sizeof(PVS_t)*ppvs[i].pvsNumber);
						for (OV_UINT j = 0; j < ppvs[i].pvsNumber; j++){
							getCoreDataRsp.pvsl[i].pvs[j].expressionLogic = ppvs[i].pvs[j].ExpressionLogic;
							getCoreDataRsp.pvsl[i].pvs[j].expressionSemantic = ppvs[i].pvs[j].ExpressionSemantic;
							SRV_String_setCopy(&getCoreDataRsp.pvsl[i].pvs[j].ID.idSpec, ppvs[i].pvs[j].ID.IdSpec, ov_string_getlength(ppvs[i].pvs[j].ID.IdSpec));
							getCoreDataRsp.pvsl[i].pvs[j].ID.idType = ppvs[i].pvs[j].ID.IdType;
							SRV_String_setCopy(&getCoreDataRsp.pvsl[i].pvs[j].name, ppvs[i].pvs[j].pvsName, ov_string_getlength(ppvs[i].pvs[j].pvsName));
							getCoreDataRsp.pvsl[i].pvs[j].hasName = TRUE;
							SRV_String_setCopy(&getCoreDataRsp.pvsl[i].pvs[j].unit, ppvs[i].pvs[j].unit, ov_string_getlength(ppvs[i].pvs[j].unit));
							getCoreDataRsp.pvsl[i].pvs[j].hasUnit = TRUE;
							OVDataValueToserviceValue(ppvs[i].pvs[j].value, &getCoreDataRsp.pvsl[i].pvs[j].valType, &getCoreDataRsp.pvsl[i].pvs[j].value, &getCoreDataRsp.pvsl[i].pvs[j].valTime);
							getCoreDataRsp.pvsl[i].pvs[j].hasValTime = TRUE;
							getCoreDataRsp.pvsl[i].pvs[j].view = ppvs[i].pvs[j].view;
							getCoreDataRsp.pvsl[i].pvs[j].visibility = ppvs[i].pvs[j].Visibility;
						}
						//PropertyValueStatementList_deleteMembers(&ppvs[i]);
					}
					//ov_database_free(ppvs);
				}

				srvStructSend = &getCoreDataRsp;
				srvTypeSend = SRV_getCoreDataRsp;

				resultOV = encodeMSG(&srvStringSend, headerSend, srvStructSend, srvTypeSend, encoding);

				getCoreDataRsp_t_deleteMembers(&getCoreDataRsp);
				sendAnswer = TRUE;
			}break;
			case SRV_getCoreDataRsp:{
				getCoreDataRsp_t *getCoreDataRsp = (getCoreDataRsp_t*)srvStructReceive;

				if (!getCoreDataRsp->status){
					for (OV_UINT i = 0; i < getCoreDataRsp->numPvsl; i++){
						OV_STRING tmpOVPVSLName = NULL;
						ov_string_setvalue(&tmpOVPVSLName, getCoreDataRsp->pvsl[i].name.data);

						IdentificationType tmpOVCarrier;
						IdentificationType_init(&tmpOVCarrier);
						ov_string_setvalue(&tmpOVCarrier.IdSpec, getCoreDataRsp->pvsl[i].carrier.idSpec.data);
						tmpOVCarrier.IdType = getCoreDataRsp->pvsl[i].carrier.idType;

						IdentificationType tmpOVCreatingInstance;
						IdentificationType_init(&tmpOVCreatingInstance);
						ov_string_setvalue(&tmpOVCreatingInstance.IdSpec, getCoreDataRsp->pvsl[i].creatingInstance.idSpec.data);
						tmpOVCreatingInstance.IdType = getCoreDataRsp->pvsl[i].creatingInstance.idType;

						//OV_TIME tmpOVCreatingTime  = ov_1601nsTimeToOvTime(getCoreDataRsp->pvsl[i].creationTime);

						IdentificationType tmpSubModelId;
						IdentificationType_init(&tmpSubModelId);

						//result = openaas_modelmanager_createPVSLTime(aasId, tmpSubModelId, tmpOVPVSLName, tmpOVCarrier, tmpOVCreatingInstance, tmpOVCreatingTime);
						for (OV_UINT j = 0; j < getCoreDataRsp->pvsl[i].numPvs; j++){
							OV_STRING tmpOVPVSLName = NULL;
							ov_string_setvalue(&tmpOVPVSLName, getCoreDataRsp->pvsl[i].name.data);

							PropertyValueStatement pvs;
							PropertyValueStatement_init(&pvs);

							ov_string_setvalue(&pvs.pvsName, getCoreDataRsp->pvsl[i].pvs[j].name.data);

							pvs.ExpressionLogic = getCoreDataRsp->pvsl[i].pvs[j].expressionSemantic;

							pvs.ExpressionSemantic = getCoreDataRsp->pvsl[i].pvs[j].expressionSemantic;

							serviceValueToOVDataValue(&pvs.value, getCoreDataRsp->pvsl[i].pvs[j].valType, getCoreDataRsp->pvsl[i].pvs[j].value, getCoreDataRsp->pvsl[i].pvs[j].valTime);

							ov_string_setvalue(&pvs.unit, getCoreDataRsp->pvsl[i].pvs[j].unit.data);

							ov_string_setvalue(&pvs.ID.IdSpec, getCoreDataRsp->pvsl[i].pvs[j].ID.idSpec.data);
							pvs.ID.IdType = getCoreDataRsp->pvsl[i].pvs[j].ID.idType;

							pvs.view = getCoreDataRsp->pvsl[i].pvs[j].view;

							pvs.Visibility = getCoreDataRsp->pvsl[i].pvs[j].visibility;

							//result = openaas_modelmanager_createPVSTime(aasId, tmpSubModelId, tmpOVPVSLName, pvs);
							PropertyValueStatement_deleteMembers(&pvs);
							ov_database_free(tmpOVPVSLName);
						}
						ov_database_free(tmpOVPVSLName);
						IdentificationType_deleteMembers(&tmpOVCarrier);
						IdentificationType_deleteMembers(&tmpOVCreatingInstance);
						IdentificationType_deleteMembers(&tmpSubModelId);
					}
				}
			}break;
			default:
				break;
			}
		}else{ // MSG is for another AAS => forward the message
			// Copy Message into Outbox
			resultOV = Ov_CreateObject(MessageSys_Message, answerMessage, &pinst->p_OUTBOX, message->v_identifier);
			if(Ov_Fail(resultOV)){
				SRV_serviceGeneric_delete(srvStructReceive, srvTypeReceive);
				SRV_msgHeader_t_delete(headerReceive);
				SRV_msgHeader_t_delete(headerSend);
				SRV_String_delete(srvStringReceive);
				SRV_String_delete(srvStringSend);
				IdentificationType_deleteMembers(&aasId);
				IdentificationType_deleteMembers(&receiver);
				Ov_DeleteObject((OV_INSTPTR_ov_object) message);
				ov_logfile_error("Could not copy message in outbox. Reason: %s", ov_result_getresulttext(resultOV));
				return;
			}
			MessageSys_Message_receiverAddress_set(answerMessage, message->v_receiverAddress);
			MessageSys_Message_receiverName_set(answerMessage, message->v_receiverName);
			MessageSys_Message_receiverComponent_set(answerMessage, message->v_receiverComponent);
			MessageSys_Message_senderAddress_set(answerMessage, message->v_senderAddress);
			MessageSys_Message_senderName_set(answerMessage, message->v_senderName);
			MessageSys_Message_senderComponent_set(answerMessage, message->v_senderComponent);
			MessageSys_Message_msgID_set(answerMessage, message->v_msgID);
			MessageSys_Message_msgStatus_set(answerMessage, message->v_msgStatus);
			MessageSys_Message_msgBody_set(answerMessage, message->v_msgBody);
			ov_string_setvalue(&answerMessage->v_auth, message->v_auth);
			answerMessage->v_expectAnswer = message->v_expectAnswer;
			ov_string_setvalue(&answerMessage->v_refMsgID, message->v_refMsgID);
			answerMessage->v_sendBy = message->v_sendBy;
			pinst->v_MsgIdForMessageForwarded = MessageSys_Message_msgID_get(answerMessage);
			answerMessage->v_msgStatus = MSGWAITING;

			ov_string_setvalue(&pinst->v_receiverForMessageForwardedIdString, receiver.IdSpec);
			pinst->v_receiverForMessageForwardedIdType = receiver.IdType;

			// Process the Message
			IdentificationType sender;
			IdentificationType_init(&sender);
			ov_string_setvalue(&sender.IdSpec, headerReceive->sender.idSpec.data);
			sender.IdType = headerReceive->sender.idType;
			ov_string_setvalue(&pinst->v_senderForMessageForwardedIdString, sender.IdSpec);
			pinst->v_senderForMessageForwardedIdType = sender.IdType;

			OV_STRING requestId = NULL;
			requestId = sendingRequestToDiscoveryServer(pinst, 2, sender);
			IdentificationType_deleteMembers(&sender);
			if (requestId){
				ov_string_setvalue(&pinst->v_MsgIdForGetAASIdRequest, requestId);
			}
			pinst->v_messageCount = 0;
			pinst->v_state = 3;
		}

		if (sendAnswer == TRUE){
			// Create MessageObject in Outbox
			ov_string_setvalue(&tempString, NULL);
			ov_string_setvalue(&tempString, "answerMessageTo");
			ov_string_append(&tempString, message->v_identifier);
			resultOV = Ov_CreateObject(MessageSys_Message, answerMessage, &pinst->p_OUTBOX, tempString);
			ov_string_setvalue(&tempString, NULL);
			if(Ov_Fail(resultOV)){
				SRV_serviceGeneric_delete(srvStructReceive, srvTypeReceive);
				SRV_msgHeader_t_delete(headerReceive);
				SRV_msgHeader_t_delete(headerSend);
				SRV_String_delete(srvStringReceive);
				SRV_String_delete(srvStringSend);
				IdentificationType_deleteMembers(&aasId);
				IdentificationType_deleteMembers(&receiver);
				Ov_DeleteObject((OV_INSTPTR_ov_object) message);
				ov_logfile_error("Could not create an answerMessage. Reason: %s", ov_result_getresulttext(resultOV));
				return;
			}

			// Sender = Receiver of old message
			MessageSys_Message_senderAddress_set(answerMessage, message->v_receiverAddress);
			MessageSys_Message_senderName_set(answerMessage, message->v_receiverName);
			MessageSys_Message_senderComponent_set(answerMessage, message->v_receiverComponent);

			// Receiver = Sender of old message
			MessageSys_Message_receiverAddress_set(answerMessage, message->v_senderAddress);
			MessageSys_Message_receiverName_set(answerMessage, message->v_senderName);
			MessageSys_Message_receiverComponent_set(answerMessage, message->v_senderComponent);

			// reference Msg
			ov_string_setvalue(&answerMessage->v_refMsgID, message->v_msgID);

			// Body
			// XML Encoding
			OV_STRING answerBody = NULL;
			ov_string_setvalue(&answerBody, "<bdy>");
			ov_string_append(&answerBody, srvStringSend->data);
			ov_string_append(&answerBody, "</bdy>");
			ov_string_setvalue(&answerMessage->v_msgBody, answerBody);
			ov_string_setvalue(&answerBody, NULL);

			// Message ready for sending
			answerMessage->v_msgStatus = MSGREADYFORSENDING;

			// Search for MsgDelivery object
			Ov_ForEachChildEx(ov_instantiation, pclass_MessageSys_MsgDelivery, pmsgDelivery, MessageSys_MsgDelivery){
				if(ov_string_compare(pmsgDelivery->v_identifier, "MessageSys") == OV_STRCMP_EQUAL){
					break;
				}
			}
			if (!pmsgDelivery){
				SRV_serviceGeneric_delete(srvStructReceive, srvTypeReceive);
				SRV_msgHeader_t_delete(headerReceive);
				SRV_msgHeader_t_delete(headerSend);
				SRV_String_delete(srvStringReceive);
				SRV_String_delete(srvStringSend);
				IdentificationType_deleteMembers(&aasId);
				IdentificationType_deleteMembers(&receiver);
				Ov_DeleteObject((OV_INSTPTR_ov_object) message);
				Ov_DeleteObject((OV_INSTPTR_ov_object) answerMessage);
				ov_logfile_error("Could not find MessageSys");
				return;
			}

			// send Message
			if (MessageSys_MsgDelivery_sendMessage(pmsgDelivery, answerMessage) == FALSE){
				SRV_serviceGeneric_delete(srvStructReceive, srvTypeReceive);
				SRV_msgHeader_t_delete(headerReceive);
				SRV_msgHeader_t_delete(headerSend);
				SRV_String_delete(srvStringReceive);
				SRV_String_delete(srvStringSend);
				IdentificationType_deleteMembers(&aasId);
				IdentificationType_deleteMembers(&receiver);
				Ov_DeleteObject((OV_INSTPTR_ov_object) message);
				Ov_DeleteObject((OV_INSTPTR_ov_object) answerMessage);
				ov_logfile_error("Could not send Message");
				return;
			}
		}

		// delete all used memory
		SRV_serviceGeneric_delete(srvStructReceive, srvTypeReceive);
		SRV_msgHeader_t_delete(headerReceive);
		SRV_msgHeader_t_delete(headerSend);
		SRV_String_delete(srvStringReceive);
		SRV_String_delete(srvStringSend);
		IdentificationType_deleteMembers(&aasId);
		IdentificationType_deleteMembers(&receiver);
		Ov_DeleteObject((OV_INSTPTR_ov_object) message);
		break;
	case 3: // Forward Message Getting the sender
		// Get the next message, if any.
		pinst->v_messageCount++;
		pTaskParent=Ov_GetParent(fb_tasklist, pinst);
		tmpTimeSpan.usecs = pTaskParent->v_cyctime.usecs * pinst->v_messageCount;
		tmpTimeSpan.secs = pTaskParent->v_cyctime.secs * pinst->v_messageCount;
		if((OV_INT)tmpTimeSpan.usecs > 999999) {
			tmpTimeSpan.usecs -= 1000000;
			tmpTimeSpan.secs++;
			return;
		}
		if (tmpTimeSpan.secs > pinst->v_messageTimeOut.secs || (tmpTimeSpan.secs == pinst->v_messageTimeOut.secs && tmpTimeSpan.usecs > pinst->v_messageTimeOut.usecs)){
			pinst->v_messageCount = 0;
			IdentificationType tmpAAS;
			tmpAAS.IdSpec = NULL;
			ov_string_setvalue(&tmpAAS.IdSpec, pinst->v_receiverForMessageForwardedIdString);
			tmpAAS.IdType = pinst->v_receiverForMessageForwardedIdType;
			OV_STRING requestId = NULL;
			requestId = sendingRequestToDiscoveryServer(pinst, 2, tmpAAS);
			if (requestId){
				ov_string_setvalue(&pinst->v_MsgIdForGetAASIdRequest, requestId);
			}
		}
		// Find Message with GetAAS-Response
		pchild = NULL;
		pchild = Ov_GetLastChild(ov_containment, &pinst->p_INBOX);
		while (true){
			while (pchild && !Ov_CanCastTo(MessageSys_Message , pchild)) {
				pchild = Ov_GetPreviousChild(ov_containment, pchild);
			}
			if (pchild == NULL){
				break;
			}

			message = Ov_StaticPtrCast(MessageSys_Message, pchild);

			if (ov_string_compare(message->v_refMsgID, pinst->v_MsgIdForGetAASIdRequest) == OV_STRCMP_EQUAL){
				// Decoding the Message
				// XML Decoding
				if (strncmp(message->v_msgBody, "<bdy>", 5) != 0){ // <bdy> not found
					Ov_DeleteObject((OV_INSTPTR_ov_object) message);
					ov_logfile_info("AASComponentManager: <bdy> not found in msg. Reason");
					return;
				}
				messageLength = ov_string_getlength(message->v_msgBody);
				if (strncmp(&message->v_msgBody[messageLength-6], "</bdy>", 6) != 0){ // </bdy> not found
					Ov_DeleteObject((OV_INSTPTR_ov_object) message);
					ov_logfile_info("AASComponentManager: </bdy> not found in msg. Reason");
					return;
				}
				messageContent = malloc((messageLength-11+1)*sizeof(char));
				memcpy(messageContent, (message->v_msgBody+5), messageLength-11);
				messageContent[messageLength-11] = '\0';

				plistReq= ov_string_split(messageContent, ":", &len);
				OV_STRING *plistParameter = NULL;
				OV_UINT len2 = 0;
				plistParameter= ov_string_split(messageContent+ov_string_getlength(plistReq[0])+1, ",", &len2);
				free(messageContent);
				if (ov_string_compare(plistReq[0], "GetAASRes") == OV_STRCMP_EQUAL){
					if (ov_string_compare(plistParameter[0], "OK") == OV_STRCMP_EQUAL){ // get was successfully
						// TODO: Check ParameterType
						if (len2 == 4){
							pchild = Ov_GetLastChild(ov_containment, &pinst->p_OUTBOX);
							while (true){
								while (pchild && !Ov_CanCastTo(MessageSys_Message , pchild)) {
									pchild = Ov_GetPreviousChild(ov_containment, pchild);
								}
								if (pchild == NULL){
									pinst->v_state = 6;
									break;
								}
								answerMessage = Ov_StaticPtrCast(MessageSys_Message, pchild);
								if (ov_string_compare(answerMessage->v_msgID, pinst->v_MsgIdForMessageForwarded) == OV_STRCMP_EQUAL){
									break;
								}
								pchild = Ov_GetPreviousChild(ov_containment, pchild);
							}
							MessageSys_Message_senderAddress_set(answerMessage, plistParameter[1]);
							MessageSys_Message_senderName_set(answerMessage, plistParameter[2]);
							MessageSys_Message_senderComponent_set(answerMessage, plistParameter[3]);

							OV_STRING requestId = NULL;
							IdentificationType receiver;
							IdentificationType_init(&receiver);
							ov_string_setvalue(&receiver.IdSpec, pinst->v_receiverForMessageForwardedIdString);
							receiver.IdType = pinst->v_receiverForMessageForwardedIdType;

							requestId = sendingRequestToDiscoveryServer(pinst, 2, receiver);
							if (requestId){
								ov_string_setvalue(&pinst->v_MsgIdForGetAASIdRequest, requestId);
							}
							IdentificationType_deleteMembers(&receiver);
							pinst->v_messageCount = 0;
							pinst->v_state = 4;
						}else{
							ov_logfile_info("GetAASRes: Incorrect size of parameters");
							pinst->v_state = 7;
						}
					}else{
						ov_logfile_info("GetAASRes: Failed");
						pinst->v_state = 7;
					}
				}else{
					ov_logfile_info("Incorrect Message to GetAASReq");
					pinst->v_state = 7;
				}
				Ov_DeleteObject((OV_INSTPTR_ov_object) message);
				ov_string_freelist(plistReq);
				break;
			}
			pchild = Ov_GetPreviousChild(ov_containment, pchild);
		}
		break;
	case 4: // Forward Message Getting the receiver
		// Get the next message, if any.
		pinst->v_messageCount++;
		pTaskParent=Ov_GetParent(fb_tasklist, pinst);
		tmpTimeSpan.usecs = pTaskParent->v_cyctime.usecs * pinst->v_messageCount;
		tmpTimeSpan.secs = pTaskParent->v_cyctime.secs * pinst->v_messageCount;
		if((OV_INT)tmpTimeSpan.usecs > 999999) {
			tmpTimeSpan.usecs -= 1000000;
			tmpTimeSpan.secs++;
			return;
		}
		if (tmpTimeSpan.secs > pinst->v_messageTimeOut.secs || (tmpTimeSpan.secs == pinst->v_messageTimeOut.secs && tmpTimeSpan.usecs > pinst->v_messageTimeOut.usecs)){
			pinst->v_messageCount = 0;
			IdentificationType tmpAAS;
			tmpAAS.IdSpec = NULL;
			ov_string_setvalue(&tmpAAS.IdSpec, pinst->v_receiverForMessageForwardedIdString);
			tmpAAS.IdType = pinst->v_receiverForMessageForwardedIdType;
			OV_STRING requestId = NULL;
			requestId = sendingRequestToDiscoveryServer(pinst, 2, tmpAAS);
			if (requestId){
				ov_string_setvalue(&pinst->v_MsgIdForGetAASIdRequest, requestId);
			}
		}
		// Find Message with GetAAS-Response
		pchild = NULL;
		pchild = Ov_GetLastChild(ov_containment, &pinst->p_INBOX);
		while (true){
			while (pchild && !Ov_CanCastTo(MessageSys_Message , pchild)) {
				pchild = Ov_GetPreviousChild(ov_containment, pchild);
			}
			if (pchild == NULL){
				break;
			}

			message = Ov_StaticPtrCast(MessageSys_Message, pchild);

			if (ov_string_compare(message->v_refMsgID, pinst->v_MsgIdForGetAASIdRequest) == OV_STRCMP_EQUAL){
				// Decoding the Message
				// XML Decoding
				if (strncmp(message->v_msgBody, "<bdy>", 5) != 0){ // <bdy> not found
					Ov_DeleteObject((OV_INSTPTR_ov_object) message);
					ov_logfile_info("AASComponentManager: <bdy> not found in msg. Reason");
					return;
				}
				messageLength = ov_string_getlength(message->v_msgBody);
				if (strncmp(&message->v_msgBody[messageLength-6], "</bdy>", 6) != 0){ // </bdy> not found
					Ov_DeleteObject((OV_INSTPTR_ov_object) message);
					ov_logfile_info("AASComponentManager: </bdy> not found in msg. Reason");
					return;
				}
				messageContent = malloc((messageLength-11+1)*sizeof(char));
				memcpy(messageContent, (message->v_msgBody+5), messageLength-11);
				messageContent[messageLength-11] = '\0';

				plistReq= ov_string_split(messageContent, ":", &len);
				OV_STRING *plistParameter = NULL;
				OV_UINT len2 = 0;
				plistParameter= ov_string_split(messageContent+ov_string_getlength(plistReq[0])+1, ",", &len2);
				free(messageContent);
				if (ov_string_compare(plistReq[0], "GetAASRes") == OV_STRCMP_EQUAL){
					if (ov_string_compare(plistParameter[0], "OK") == OV_STRCMP_EQUAL){ // get was successfully
						// TODO: Check ParameterType
						if (len2 == 4){
							pchild = Ov_GetLastChild(ov_containment, &pinst->p_OUTBOX);
							while (true){
								while (pchild && !Ov_CanCastTo(MessageSys_Message , pchild)) {
									pchild = Ov_GetPreviousChild(ov_containment, pchild);
								}
								if (pchild == NULL){
									pinst->v_state = 7;
									break;
								}
								answerMessage = Ov_StaticPtrCast(MessageSys_Message, pchild);
								if (ov_string_compare(answerMessage->v_msgID, pinst->v_MsgIdForMessageForwarded) == OV_STRCMP_EQUAL){
									break;
								}
								pchild = Ov_GetPreviousChild(ov_containment, pchild);
							}
							MessageSys_Message_senderAddress_set(answerMessage, plistParameter[1]);
							MessageSys_Message_senderName_set(answerMessage, plistParameter[2]);
							MessageSys_Message_senderComponent_set(answerMessage, plistParameter[3]);

							// Message ready for sending
							answerMessage->v_msgStatus = MSGREADYFORSENDING;

							// Search for MsgDelivery object
							Ov_ForEachChildEx(ov_instantiation, pclass_MessageSys_MsgDelivery, pmsgDelivery, MessageSys_MsgDelivery){
								if(ov_string_compare(pmsgDelivery->v_identifier, "MessageSys") == OV_STRCMP_EQUAL){
									break;
								}
							}
							if (!pmsgDelivery){
								Ov_DeleteObject((OV_INSTPTR_ov_object) message);
								Ov_DeleteObject((OV_INSTPTR_ov_object) answerMessage);
								ov_logfile_error("Could not find MessageSys");
								return;
							}

							// send Message
							if (MessageSys_MsgDelivery_sendMessage(pmsgDelivery, answerMessage) == FALSE){
								Ov_DeleteObject((OV_INSTPTR_ov_object) message);
								Ov_DeleteObject((OV_INSTPTR_ov_object) answerMessage);
								ov_logfile_error("Could not send Message");
								return;
							}

							pTaskParent=Ov_GetParent(fb_tasklist, pinst);
							if(pTaskParent->v_cyctime.secs > 0)
								pinst->v_messageCount = pinst->v_messageTimeOut.secs / pTaskParent->v_cyctime.secs;
							else
								pinst->v_messageCount = pinst->v_messageTimeOut.usecs / pTaskParent->v_cyctime.usecs;
							pinst->v_state = 2;
						}else{
							ov_logfile_info("GetAASRes: Incorrect size of parameters");
							pinst->v_state = 7;
						}
					}else{
						ov_logfile_info("GetAASRes: Failed");
						pinst->v_state = 7;
					}
				}else{
					ov_logfile_info("Incorrect Message to GetAASReq");
					pinst->v_state = 7;
				}
				Ov_DeleteObject((OV_INSTPTR_ov_object) message);
				ov_string_freelist(plistReq);
				break;
			}
			pchild = Ov_GetPreviousChild(ov_containment, pchild);
		}
		break;
	case 5: //Sending Unregister-Request and wait for answer
		// Get the next message, if any.
		if (pinst->v_registered == FALSE){
			pinst->v_state = 6;
		}
		pinst->v_messageCount++;
		pTaskParent=Ov_GetParent(fb_tasklist, pinst);
		tmpTimeSpan.usecs = pTaskParent->v_cyctime.usecs * pinst->v_messageCount;
		tmpTimeSpan.secs = pTaskParent->v_cyctime.secs * pinst->v_messageCount;
		if((OV_INT)tmpTimeSpan.usecs > 999999) {
			tmpTimeSpan.usecs -= 1000000;
			tmpTimeSpan.secs++;
			return;
		}
		if (tmpTimeSpan.secs > pinst->v_messageTimeOut.secs || (tmpTimeSpan.secs == pinst->v_messageTimeOut.secs && tmpTimeSpan.usecs > pinst->v_messageTimeOut.usecs)){
			pinst->v_messageCount = 0;
			IdentificationType tmpAASId;
			sendingRequestToDiscoveryServer(pinst, 1, tmpAASId);
		}
		message = getNextMessage(pinst);
		if (message == NULL) {
			// Nothing to do.
			return;
		}
		// Decoding the Message
		// XML Decoding
		if (strncmp(message->v_msgBody, "<bdy>", 5) != 0){ // <bdy> not found
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: <bdy> not found in msg. Reason");
			return;
		}
		messageLength = ov_string_getlength(message->v_msgBody);
		if (strncmp(&message->v_msgBody[messageLength-6], "</bdy>", 6) != 0){ // </bdy> not found
			Ov_DeleteObject((OV_INSTPTR_ov_object) message);
			ov_logfile_info("AASComponentManager: </bdy> not found in msg. Reason");
			return;
		}
		messageContent = malloc((messageLength-11+1)*sizeof(char));
		memcpy(messageContent, (message->v_msgBody+5), messageLength-11);
		messageContent[messageLength-11] = '\0';

		plistReq= ov_string_split(messageContent, ":", &len);
		free (messageContent);
		if (ov_string_compare(plistReq[0], "UnregisterAASRes") == OV_STRCMP_EQUAL){ // unregister response
			if (ov_string_compare(plistReq[1], "OK") == OV_STRCMP_EQUAL){ // unregister was successfully
				pinst->v_state = 6;
			}else{ // Error
				ov_string_setvalue(&pinst->v_errorText, plistReq[1]);
				pinst->v_state = 7;
			}
		}else{ // no register response => delete message and wait for next one
		}
		Ov_DeleteObject((OV_INSTPTR_ov_object) message);
		ov_string_freelist(plistReq);
		break;
		break;
	case 6: //Ready for delete or reset
		break;
	case 7: // Error, wait for reset
		break;
	default:
		break;
	}
	return;
}


OV_DLLFNCEXPORT AASStatusCode openaas_AASComponentManager_sendMessage(OV_INSTPTR_openaas_AASComponentManager this,IdentificationType senderAASId, IdentificationType receiverAASId, OV_UINT msgNo, SRV_service_t serviceType, void* srvStruct) {
	OV_STRING tempString = NULL;
	OV_INSTPTR_MessageSys_Message message = NULL;
	OV_RESULT resultOV = 0;
	OV_UINT ID = 4294967295;

	// Create MessageObject in Inbox
	srand ( time(NULL) );
	LOCALMSGCOUNTER = LOCALMSGCOUNTER + 1;
	while(ID>=4294967295){
		ID = (((rand() % 1625)+1) * ((rand() % 1625)+1) * ((rand() % 1625)+1)) + LOCALMSGCOUNTER;
	}
	ov_string_print(&tempString, "%lu", ID);
	resultOV = Ov_CreateObject(MessageSys_Message, message, &this->p_INBOX, tempString);
	ov_string_setvalue(&tempString, NULL);
	if(Ov_Fail(resultOV)){
		ov_logfile_error("Could not create an Message. Reason: %s", ov_result_getresulttext(resultOV));
		return AASSTATUSCODE_BADUNEXPECTEDERROR;
	}

	// Sender unknown
	MessageSys_Message_senderAddress_set(message, NULL);
	MessageSys_Message_senderName_set(message,NULL);
	MessageSys_Message_senderComponent_set(message, NULL);

	// Receiver unknown
	MessageSys_Message_receiverAddress_set(message, NULL);
	MessageSys_Message_receiverName_set(message, NULL);
	MessageSys_Message_receiverComponent_set(message, NULL);

	// reference Msg
	ov_string_setvalue(&message->v_refMsgID, NULL);

	// Body
	// For encoding the message
	SRV_String *srvStringSend = NULL;
	SRV_msgHeader *headerSend = SRV_msgHeader_t_new();
	headerSend->msgNo = msgNo;
	SRV_String_setCopy(&headerSend->sender.idSpec, senderAASId.IdSpec, ov_string_getlength(senderAASId.IdSpec));
	headerSend->sender.idType = senderAASId.IdType;
	SRV_String_setCopy(&headerSend->receiver.idSpec, receiverAASId.IdSpec, ov_string_getlength(receiverAASId.IdSpec));
	headerSend->receiver.idType = receiverAASId.IdType;

	resultOV = encodeMSG(&srvStringSend, headerSend, srvStruct, serviceType, SRV_JSON);
	// XML Encoding
	OV_STRING answerBody = NULL;
	ov_string_setvalue(&answerBody, "<bdy>");
	ov_string_append(&answerBody, srvStringSend->data);
	ov_string_append(&answerBody, "</bdy>");
	ov_string_setvalue(&message->v_msgBody, answerBody);
	ov_string_setvalue(&answerBody, NULL);
	SRV_msgHeader_t_delete(headerSend);
	SRV_String_delete(srvStringSend);

	// Message ready for sending
	message->v_msgStatus = MSGDONE;

    return (AASStatusCode)0;
}

