
/******************************************************************************
*
*   FILE
*   ----
*   openAASDiscoveryServerHTTPExt.c
*
*   History
*   -------
*   2018-09-12   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_openAASDiscoveryServerHTTP
#define OV_COMPILE_LIBRARY_openAASDiscoveryServerHTTP
#endif


#include "openAASDiscoveryServerHTTP.h"
#include "libov/ov_macros.h"
#include "ks_logfile.h"
#include "libov/ov_result.h"
#include "libov/ov_path.h"
#include "json_helper.h"


OV_DLLFNCEXPORT OV_RESULT openAASDiscoveryServerHTTP_openAASDiscoveryServerHTTPExt_constructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_openAASDiscoveryServerHTTP_openAASDiscoveryServerHTTPExt pinst = Ov_StaticPtrCast(openAASDiscoveryServerHTTP_openAASDiscoveryServerHTTPExt, pobj);
    OV_RESULT    result;

    /* do what the base class does first */
    result = ksbase_ComTask_constructor(pobj);
    if(Ov_Fail(result))
         return result;

    /* do what */
    result = Ov_SetDynamicVectorLength(&pinst->v_commandList, 4, STRING);
	if(Ov_Fail(result))
		return result;
	result = ov_string_setvalue(&pinst->v_commandList.value[0], "*/securityCheck");
	if(Ov_Fail(result))
		return result;
	result = ov_string_setvalue(&pinst->v_commandList.value[1], "*/registerAAS");
	if(Ov_Fail(result))
		return result;
	result = ov_string_setvalue(&pinst->v_commandList.value[2], "*/unregisterAAS");
	if(Ov_Fail(result))
		return result;
	result = ov_string_setvalue(&pinst->v_commandList.value[3], "*/searchForAAS");
	if(Ov_Fail(result))
		return result;

    return OV_ERR_OK;
}

OV_RESULT getDiscoveryServer(OV_INSTPTR_openAASDiscoveryServer_DiscoveryServer *pDiscoveryServer, OV_STRING url, OV_STRING **pList, OV_UINT *len, OV_UINT *count){
	OV_STRING ressourcePath = NULL;
	*pList = ov_string_split(url, "/", len);
	for (*count = 0; *count < (*len)-1; (*count)++){
		if (*count == 0){
			ov_string_setvalue(&ressourcePath, (*pList)[*count]);
			continue;
		}
		ov_string_append(&ressourcePath, "/");
		ov_string_append(&ressourcePath, (*pList)[*count]);
	}

	*pDiscoveryServer = Ov_DynamicPtrCast(openAASDiscoveryServer_DiscoveryServer, ov_path_getobjectpointer(ressourcePath, 2));
	ov_string_setvalue(&ressourcePath, NULL);
	if (!*pDiscoveryServer){
		KS_logfile_info(("could not find discoveryServer object"));
		ov_string_freelist(*pList);
		return OV_ERR_BADPARAM;
	}

	return OV_ERR_OK;
}

OV_DLLFNCEXPORT OV_RESULT openAASDiscoveryServerHTTP_openAASDiscoveryServerHTTPExt_HandleExtendedRequest(
	const OV_INSTPTR_kshttp_httpClientHandlerExtension	pobj,
	const OV_INSTPTR_kshttp_httpclienthandler	pClientHandler,
	const OV_INSTPTR_ksbase_Channel pChannel,
	const HTTP_REQUEST request,
	HTTP_RESPONSE *response
) {
    /*    
    *   local variables
    */
	OV_UINT len = 0;
	OV_STRING* pList = NULL;
	OV_INSTPTR_openaas_InterfaceDiscoveryServer pInterfaceDiscoveryServer = NULL;
	OV_INSTPTR_openAASDiscoveryServer_DiscoveryServer pDiscoveryServer = NULL;
	OV_UINT count = 0;
	OV_STRING JsonOutput = NULL;
	OV_STRING errorMessage = NULL;
	OV_VTBLPTR_openAASDiscoveryServer_Registration pvtableRegistration = NULL;
	OV_VTBLPTR_openAASDiscoveryServer_Security pvtableSecurity = NULL;
	OV_VTBLPTR_openAASDiscoveryServer_Search pvtableSearch = NULL;

	// check if InterfaceDiscoverServer exist
	pInterfaceDiscoveryServer = Ov_StaticPtrCast(openaas_InterfaceDiscoveryServer, Ov_GetFirstChild(ov_instantiation, pclass_openaas_InterfaceDiscoveryServer));
	if(!pInterfaceDiscoveryServer){
		KS_logfile_info("InterfaceDiscoveryServer not found");
		ov_string_setvalue(&response->contentString, "Internal Error");
		return OV_ERR_OK;
	}

	// get DiscoveryServer
	if (getDiscoveryServer(&pDiscoveryServer, request.urlPath, &pList, &len, &count) != OV_ERR_OK){
		ov_string_setvalue(&response->contentString, HTTP_404_BODY);
		return OV_ERR_OK;
	}

	if(request.urlQuery.veclen != 2){
		KS_logfile_info(("wrong data size in content", request.requestMethod));
		ov_string_setvalue(&response->contentString, "wrong data size\n");
		return OV_ERR_BADVALUE;
	}
	if (ov_string_compare(request.urlQuery.value[0], "data") != OV_STRCMP_EQUAL){
		KS_logfile_info(("wrong key in content", request.requestMethod));
		ov_string_setvalue(&response->contentString, "wrong key\n");
		return OV_ERR_BADVALUE;
	}

	json_data jsonData;
	json_data_init(&jsonData);
	ov_string_setvalue(&jsonData.js, "\"body\":");
	ov_string_append(&jsonData.js, request.urlQuery.value[1]);

	if(jsonTokenize(&jsonData) != OV_ERR_OK) {
		KS_logfile_info(("value not in correct json format", request.requestMethod));
		ov_string_setvalue(&response->contentString, "value not in correct json format\n");
		return OV_ERR_BADVALUE;
	}

	if (ov_string_compare(pList[count], "securityCheck") == OV_STRCMP_EQUAL){
		Ov_GetVTablePtr(openAASDiscoveryServer_Security, pvtableSecurity, &pDiscoveryServer->p_Security);
		if (pvtableSecurity){
			if (pvtableSecurity->m_getSecurityMessage(Ov_DynamicPtrCast(openAASDiscoveryServer_Part, &pDiscoveryServer->p_Security), jsonData, &JsonOutput, &errorMessage) != OV_ERR_OK){
				ov_string_setvalue(&JsonOutput, NULL);
				KS_logfile_info(("Error in part-function: %s", errorMessage));
				ov_string_setvalue(&response->contentString, "Internal Error\n");
				ov_string_setvalue(&errorMessage, NULL);
				json_data_deleteMembers(&jsonData);
				return OV_ERR_BADVALUE;
			}
			json_data_deleteMembers(&jsonData);
			if (errorMessage){
				ov_string_setvalue(&JsonOutput, NULL);
				KS_logfile_info(("Error in part-function: %s", errorMessage));
				ov_string_setvalue(&response->contentString, errorMessage);
				ov_string_setvalue(&errorMessage, NULL);
				return OV_ERR_BADVALUE;
			}else{
				ov_string_setvalue(&response->contentString, (JsonOutput+7));
				ov_string_setvalue(&JsonOutput, NULL);
				ov_string_setvalue(&errorMessage, NULL);
				return OV_ERR_OK;
			}
		}else{
			json_data_deleteMembers(&jsonData);
			KS_logfile_info(("Could not get VTable Pointer of Security-Object", request.requestMethod));
			ov_string_setvalue(&response->contentString, "Internal Error\n");
			return OV_ERR_BADVALUE;
		}
	}else if (ov_string_compare(pList[count], "registerAAS") == OV_STRCMP_EQUAL){
		Ov_GetVTablePtr(openAASDiscoveryServer_Registration, pvtableRegistration, &pDiscoveryServer->p_Registration);
		if (pvtableRegistration){
			if (pvtableRegistration->m_getRegistrationMessage(Ov_DynamicPtrCast(openAASDiscoveryServer_Part, &pDiscoveryServer->p_Registration), jsonData, &JsonOutput, &errorMessage) != OV_ERR_OK){
				ov_string_setvalue(&JsonOutput, NULL);
				KS_logfile_info(("Error in part-function: %s", errorMessage));
				ov_string_setvalue(&response->contentString, "Internal Error\n");
				ov_string_setvalue(&errorMessage, NULL);
				json_data_deleteMembers(&jsonData);
				return OV_ERR_BADVALUE;
			}
			json_data_deleteMembers(&jsonData);
			if (errorMessage){
				ov_string_setvalue(&JsonOutput, NULL);
				KS_logfile_info(("Error in part-function: %s", errorMessage));
				ov_string_setvalue(&response->contentString, errorMessage);
				ov_string_setvalue(&errorMessage, NULL);
				return OV_ERR_BADVALUE;
			}else{
				ov_string_setvalue(&response->contentString, (JsonOutput+7));
				ov_string_setvalue(&JsonOutput, NULL);
				ov_string_setvalue(&errorMessage, NULL);
				return OV_ERR_OK;
			}
		}else{
			json_data_deleteMembers(&jsonData);
			KS_logfile_info(("Could not get VTable Pointer of Registration-Object", request.requestMethod));
			ov_string_setvalue(&response->contentString, "Internal Error\n");
			return OV_ERR_BADVALUE;
		}
	}else if (ov_string_compare(pList[count], "unregisterAAS") == OV_STRCMP_EQUAL){
		Ov_GetVTablePtr(openAASDiscoveryServer_Registration, pvtableRegistration, &pDiscoveryServer->p_Registration);
		if (pvtableRegistration){
			if (pvtableRegistration->m_getUnregistrationMessage(Ov_DynamicPtrCast(openAASDiscoveryServer_Part, &pDiscoveryServer->p_Registration), jsonData, &JsonOutput, &errorMessage) != OV_ERR_OK){
				ov_string_setvalue(&JsonOutput, NULL);
				KS_logfile_info(("Error in part-function: %s", errorMessage));
				ov_string_setvalue(&response->contentString, "Internal Error\n");
				ov_string_setvalue(&errorMessage, NULL);
				json_data_deleteMembers(&jsonData);
				return OV_ERR_BADVALUE;
			}
			json_data_deleteMembers(&jsonData);
			if (errorMessage){
				ov_string_setvalue(&JsonOutput, NULL);
				KS_logfile_info(("Error in part-function: %s", errorMessage));
				ov_string_setvalue(&response->contentString, errorMessage);
				ov_string_setvalue(&errorMessage, NULL);
				return OV_ERR_BADVALUE;
			}else{
				ov_string_setvalue(&response->contentString, (JsonOutput+7));
				ov_string_setvalue(&JsonOutput, NULL);
				ov_string_setvalue(&errorMessage, NULL);
				return OV_ERR_OK;
			}
		}else{
			json_data_deleteMembers(&jsonData);
			KS_logfile_info(("Could not get VTable Pointer of Registration-Object", request.requestMethod));
			ov_string_setvalue(&response->contentString, "Internal Error\n");
			return OV_ERR_BADVALUE;
		}
	}else if (ov_string_compare(pList[count], "searchForAAS") == OV_STRCMP_EQUAL){
		Ov_GetVTablePtr(openAASDiscoveryServer_Search, pvtableSearch, &pDiscoveryServer->p_Search);
		if (pvtableSearch){
			if (pvtableSearch->m_getSearchMessage(Ov_DynamicPtrCast(openAASDiscoveryServer_Part, &pDiscoveryServer->p_Search), jsonData, &JsonOutput, &errorMessage) != OV_ERR_OK){
				ov_string_setvalue(&JsonOutput, NULL);
				KS_logfile_info(("Error in part-function: %s", errorMessage));
				ov_string_setvalue(&response->contentString, "Internal Error\n");
				ov_string_setvalue(&errorMessage, NULL);
				json_data_deleteMembers(&jsonData);
				return OV_ERR_BADVALUE;
			}
			json_data_deleteMembers(&jsonData);
			if (errorMessage){
				ov_string_setvalue(&JsonOutput, NULL);
				KS_logfile_info(("Error in part-function: %s", errorMessage));
				ov_string_setvalue(&response->contentString, errorMessage);
				ov_string_setvalue(&errorMessage, NULL);
				return OV_ERR_BADVALUE;
			}else{
				ov_string_setvalue(&response->contentString, (JsonOutput+7));
				ov_string_setvalue(&JsonOutput, NULL);
				ov_string_setvalue(&errorMessage, NULL);
				return OV_ERR_OK;
			}
		}else{
			json_data_deleteMembers(&jsonData);
			KS_logfile_info(("Could not get VTable Pointer of Search-Object", request.requestMethod));
			ov_string_setvalue(&response->contentString, "Internal Error\n");
			return OV_ERR_BADVALUE;
		}
	}else{
		json_data_deleteMembers(&jsonData);
		KS_logfile_info(("incompatible requestMethod %s for openaasHTTP Extension", request.requestMethod));
		ov_string_setvalue(&response->contentString, "bad requestMethod for handler\n");
		return OV_ERR_BADPARAM;
	}
	response->keepAlive = FALSE;

    return OV_ERR_OK;
}

