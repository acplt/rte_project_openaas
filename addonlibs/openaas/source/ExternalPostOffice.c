
/******************************************************************************
*
*   FILE
*   ----
*   ExternalPostOffice.c
*
*   History
*   -------
*   2017-02-17   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_openaas
#define OV_COMPILE_LIBRARY_openaas
#endif


#include "openaas.h"
#include "libov/ov_macros.h"


OV_DLLFNCEXPORT OV_RESULT openaas_ExternalPostOffice_postoffice_set(
    OV_INSTPTR_openaas_ExternalPostOffice          pobj,
    const OV_STRING  value
) {
	pobj->v_actimode = 1;
	pobj->v_iexreq = true;
    return ov_string_setvalue(&pobj->v_postoffice,value);
}

OV_DLLFNCEXPORT OV_ACCESS openaas_ExternalPostOffice_getaccess(
	OV_INSTPTR_ov_object	pobj,
	const OV_ELEMENT		*pelem,
	const OV_TICKET			*pticket
) {
    /*    
    *   local variables
    */

	return (OV_ACCESS)OV_AC_WRITE | OV_AC_READ | OV_AC_LINKABLE | OV_AC_UNLINKABLE | OV_AC_DELETEABLE | OV_AC_RENAMEABLE;
}

OV_DLLFNCEXPORT void openaas_ExternalPostOffice_typemethod(
	OV_INSTPTR_fb_functionblock	pfb,
	OV_TIME						*pltc
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_openaas_ExternalPostOffice pinst = Ov_StaticPtrCast(openaas_ExternalPostOffice, pfb);
    OV_INSTPTR_ksapi_getVar pGetComCoAddressFromAASDiscoveryServer = NULL;
    Ov_ForEachChildEx(ov_instantiation, pclass_ksapi_getVar, pGetComCoAddressFromAASDiscoveryServer, ksapi_getVar){
		if(ov_string_compare(pGetComCoAddressFromAASDiscoveryServer->v_identifier, "GetComCoAddressFromAASDiscoveryServer") == OV_STRCMP_EQUAL){
			break;
		}
	}
    if(!pGetComCoAddressFromAASDiscoveryServer){
    	return;
    }

	OV_INSTPTR_ksapi_KSApiCommon pKSApiGetCommon = Ov_StaticPtrCast(ksapi_KSApiCommon, pGetComCoAddressFromAASDiscoveryServer);

	OV_INSTPTR_openaas_nodeStoreFunctions pNodeStoreFunctions = NULL;
	pNodeStoreFunctions = Ov_StaticPtrCast(openaas_nodeStoreFunctions, Ov_GetFirstChild(ov_instantiation, pclass_openaas_nodeStoreFunctions));
	OV_STRING getComCoAddressMsg = NULL;
    switch (pinst->v_state){
    case 0:
		// Get ServerHost of ComCo
		ov_string_setvalue(&pGetComCoAddressFromAASDiscoveryServer->v_serverHost, pNodeStoreFunctions->v_IPAddressAASDiscoveryServer);
		ov_string_setvalue(&pGetComCoAddressFromAASDiscoveryServer->v_serverName, pNodeStoreFunctions->v_ManagerNameAASDiscoveryServer);
		ov_string_setvalue(&pGetComCoAddressFromAASDiscoveryServer->v_path, pNodeStoreFunctions->v_PathToAASDiscoveryServer);
		ov_string_append(&pGetComCoAddressFromAASDiscoveryServer->v_path, "/");
		getComCoAddressMsg = NULL;
		ov_string_print(&getComCoAddressMsg, "%x", pinst->v_ReceiverAASIdType);
		for (OV_UINT i = 0; i < ov_string_getlength(pinst->v_ReceiverAASIdString); i++){
			OV_STRING tmpHexString2 = NULL;
			ov_string_print(&tmpHexString2, "%x", pinst->v_ReceiverAASIdString[i]);
			ov_string_append(&getComCoAddressMsg, tmpHexString2);
			ov_database_free(tmpHexString2);
		}
		ov_string_append(&pGetComCoAddressFromAASDiscoveryServer->v_path, getComCoAddressMsg);
		ov_string_append(&pGetComCoAddressFromAASDiscoveryServer->v_path, ".ServerHost");

		ksapi_KSApiCommon_Reset_set(pKSApiGetCommon, FALSE);
		ksapi_KSApiCommon_Reset_set(pKSApiGetCommon, TRUE);
		ksapi_KSApiCommon_Submit_set(pKSApiGetCommon, FALSE);
		ksapi_KSApiCommon_Submit_set(pKSApiGetCommon, TRUE);
		pinst->v_state = 1;
	break;
    case 1:
		if (pGetComCoAddressFromAASDiscoveryServer->v_status != 2){
			break;
		}

		ov_string_setvalue(&pinst->v_tmpServerHost, pGetComCoAddressFromAASDiscoveryServer->v_varValue.value.valueunion.val_string);

		// Get Manager Name of ComCo
		ov_string_setvalue(&pGetComCoAddressFromAASDiscoveryServer->v_serverHost, pNodeStoreFunctions->v_IPAddressAASDiscoveryServer);
		ov_string_setvalue(&pGetComCoAddressFromAASDiscoveryServer->v_serverName, pNodeStoreFunctions->v_ManagerNameAASDiscoveryServer);
		ov_string_setvalue(&pGetComCoAddressFromAASDiscoveryServer->v_path, pNodeStoreFunctions->v_PathToAASDiscoveryServer);
		ov_string_append(&pGetComCoAddressFromAASDiscoveryServer->v_path, "/");
		getComCoAddressMsg = NULL;
		ov_string_print(&getComCoAddressMsg, "%x", pinst->v_ReceiverAASIdType);
		for (OV_UINT i = 0; i < ov_string_getlength(pinst->v_ReceiverAASIdString); i++){
			OV_STRING tmpHexString2 = NULL;
			ov_string_print(&tmpHexString2, "%x", pinst->v_ReceiverAASIdString[i]);
			ov_string_append(&getComCoAddressMsg, tmpHexString2);
			ov_database_free(tmpHexString2);
		}
		ov_string_append(&pGetComCoAddressFromAASDiscoveryServer->v_path, getComCoAddressMsg);
		ov_string_append(&pGetComCoAddressFromAASDiscoveryServer->v_path, ".ServerName");

		ksapi_KSApiCommon_Reset_set(pKSApiGetCommon, FALSE);
		ksapi_KSApiCommon_Reset_set(pKSApiGetCommon, TRUE);
		ksapi_KSApiCommon_Submit_set(pKSApiGetCommon, FALSE);
		ksapi_KSApiCommon_Submit_set(pKSApiGetCommon, TRUE);
		pinst->v_state = 2;
		break;
    case 2:
		if (pGetComCoAddressFromAASDiscoveryServer->v_status != 2){
			break;
		}

		ov_string_setvalue(&pinst->v_tmpManagerName, pGetComCoAddressFromAASDiscoveryServer->v_varValue.value.valueunion.val_string);

		// Get Path of ComCo
		ov_string_setvalue(&pGetComCoAddressFromAASDiscoveryServer->v_serverHost, pNodeStoreFunctions->v_IPAddressAASDiscoveryServer);
		ov_string_setvalue(&pGetComCoAddressFromAASDiscoveryServer->v_serverName, pNodeStoreFunctions->v_ManagerNameAASDiscoveryServer);
		ov_string_setvalue(&pGetComCoAddressFromAASDiscoveryServer->v_path, pNodeStoreFunctions->v_PathToAASDiscoveryServer);
		ov_string_append(&pGetComCoAddressFromAASDiscoveryServer->v_path, "/");
		getComCoAddressMsg = NULL;
		ov_string_print(&getComCoAddressMsg, "%x", pinst->v_ReceiverAASIdType);
		for (OV_UINT i = 0; i < ov_string_getlength(pinst->v_ReceiverAASIdString); i++){
			OV_STRING tmpHexString2 = NULL;
			ov_string_print(&tmpHexString2, "%x", pinst->v_ReceiverAASIdString[i]);
			ov_string_append(&getComCoAddressMsg, tmpHexString2);
			ov_database_free(tmpHexString2);
		}
		ov_string_append(&pGetComCoAddressFromAASDiscoveryServer->v_path, getComCoAddressMsg);
		ov_string_append(&pGetComCoAddressFromAASDiscoveryServer->v_path, ".Path");

		ksapi_KSApiCommon_Reset_set(pKSApiGetCommon, FALSE);
		ksapi_KSApiCommon_Reset_set(pKSApiGetCommon, TRUE);
		ksapi_KSApiCommon_Submit_set(pKSApiGetCommon, FALSE);
		ksapi_KSApiCommon_Submit_set(pKSApiGetCommon, TRUE);
		pinst->v_state = 3;
		break;
    case 3:
		if (pGetComCoAddressFromAASDiscoveryServer->v_status != 2){
			break;
		}

		ov_string_setvalue(&pinst->v_tmpPath, pGetComCoAddressFromAASDiscoveryServer->v_varValue.value.valueunion.val_string);

		// Get the pointer to object for send the Message
		OV_INSTPTR_ksapi_setVar psendAASMessage = NULL;
		Ov_ForEachChildEx(ov_instantiation, pclass_ksapi_setVar, psendAASMessage, ksapi_setVar){
			if(ov_string_compare(psendAASMessage->v_identifier, "SendAASMessage") == OV_STRCMP_EQUAL){
				break;
			}
		}
		if(psendAASMessage){
			OV_INSTPTR_ksapi_KSApiCommon pKSApiSendCommon = Ov_StaticPtrCast(ksapi_KSApiCommon, psendAASMessage);

			ov_string_setvalue(&psendAASMessage->v_serverHost, pinst->v_tmpServerHost);
			ov_string_setvalue(&psendAASMessage->v_serverName, pinst->v_tmpManagerName);
			ov_string_setvalue(&psendAASMessage->v_path, pinst->v_tmpPath);
			ov_string_append(&psendAASMessage->v_path, ".postoffice");
			// send message
			Ov_SetAnyValue(&psendAASMessage->v_varValue, NULL);
			psendAASMessage->v_varValue.value.valueunion.val_string = NULL;
			ov_string_setvalue(&psendAASMessage->v_varValue.value.valueunion.val_string, pinst->v_postoffice);
			psendAASMessage->v_varValue.value.vartype = OV_VT_STRING;

			ksapi_KSApiCommon_Reset_set(pKSApiSendCommon, FALSE);
			ksapi_KSApiCommon_Reset_set(pKSApiSendCommon, TRUE);
			ksapi_KSApiCommon_Submit_set(pKSApiSendCommon, FALSE);
			ksapi_KSApiCommon_Submit_set(pKSApiSendCommon, TRUE);

			ov_string_setvalue(&pinst->v_lastSendMessage, pinst->v_postoffice);
			ov_string_setvalue(&pinst->v_postoffice,"");
			pinst->v_state = 0;
			pinst->v_actimode = 0;
			pinst->v_iexreq = false;
		}
		break;
    }
    ov_database_free(getComCoAddressMsg);
    return;
}

