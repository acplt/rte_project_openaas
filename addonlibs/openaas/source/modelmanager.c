
/******************************************************************************
*
*   FILE
*   ----
*   modelmanager.c
*
*   History
*   -------
*   2016-12-22   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_openaas
#define OV_COMPILE_LIBRARY_openaas
#endif


#include "openaas.h"
#include "libov/ov_macros.h"
#include "nodeset.h"
#include "ua_openaas_generated.h"
#include "openaas_helpers.h"

extern OV_INSTPTR_openaas_nodeStoreFunctions pNodeStoreFunctions;

void openaas_modelmanager_AASConvertListAdd(IdentificationType aasId, OV_STRING aasName){
	OV_INSTPTR_openaas_modelmanager pmodelmanager = NULL;
	OV_INSTPTR_openaas_AASConvertListType pListElement = NULL;

	pmodelmanager = Ov_StaticPtrCast(openaas_modelmanager, Ov_GetFirstChild(ov_instantiation, pclass_openaas_modelmanager));

	Ov_ForEachChildEx(ov_containment, Ov_StaticPtrCast(ov_domain, pmodelmanager), pListElement, openaas_AASConvertListType){
		if (ov_string_compare(pListElement->v_AASIdString, aasId.IdSpec) == OV_STRCMP_EQUAL && pListElement->v_AASIdType == aasId.IdType)
			return;
	}

	OV_STRING tmpString = NULL;
	ov_string_print(&tmpString, "%i", pmodelmanager->v_ListCount+1);
	if (Ov_Fail(Ov_CreateObject(openaas_AASConvertListType, pListElement, Ov_StaticPtrCast(ov_domain, pmodelmanager), tmpString))){
		ov_database_free(tmpString);
		return;
	}
	ov_database_free(tmpString);
	pmodelmanager->v_ListSize += 1;
	pmodelmanager->v_ListCount += 1;
	ov_string_setvalue(&pListElement->v_AASIdString, aasId.IdSpec);
	pListElement->v_AASIdType = aasId.IdType;
	tmpString = NULL;
	ov_string_setvalue(&tmpString, "/TechUnits/openAAS/AASFolder/");
	ov_string_append(&tmpString, aasName);
	ov_string_setvalue(&pListElement->v_AASPath, tmpString);
	ov_database_free(tmpString);

	// Get the pointer to object for send the Message
	OV_INSTPTR_ksapi_setVar psendAASMessage = NULL;
	Ov_ForEachChildEx(ov_instantiation, pclass_ksapi_setVar, psendAASMessage, ksapi_setVar){
		if(ov_string_compare(psendAASMessage->v_identifier, "SendAASMessage") == OV_STRCMP_EQUAL){
			break;
		}
	}

	ov_string_setvalue(&psendAASMessage->v_serverHost, pNodeStoreFunctions->v_IPAddressAASDiscoveryServer);
	ov_string_setvalue(&psendAASMessage->v_serverName, pNodeStoreFunctions->v_ManagerNameAASDiscoveryServer);
	ov_string_setvalue(&psendAASMessage->v_path, pNodeStoreFunctions->v_PathToAASDiscoveryServer);
	ov_string_append(&psendAASMessage->v_path, ".AddOVDataForAAS");

	OV_STRING tmpHexString = NULL;
	ov_string_print(&tmpHexString, "%x", aasId.IdType);

	for (OV_UINT i = 0; i < ov_string_getlength(aasId.IdSpec); i++){
		OV_STRING tmpHexString2 = NULL;
		ov_string_print(&tmpHexString2, "%x", aasId.IdSpec[i]);
		ov_string_append(&tmpHexString, tmpHexString2);
		ov_database_free(tmpHexString2);
	}

	psendAASMessage->v_varValue.value.vartype = OV_VT_STRING_VEC;
	psendAASMessage->v_varValue.value.valueunion.val_string_vec.veclen = 0;
	psendAASMessage->v_varValue.value.valueunion.val_string_vec.value = NULL;
	Ov_SetDynamicVectorLength(&psendAASMessage->v_varValue.value.valueunion.val_string_vec, 4, STRING);

	psendAASMessage->v_varValue.value.valueunion.val_string_vec.value[0] = NULL;
	ov_string_setvalue(&psendAASMessage->v_varValue.value.valueunion.val_string_vec.value[0], tmpHexString);
	psendAASMessage->v_varValue.value.valueunion.val_string_vec.value[1] = NULL;
	ov_string_setvalue(&psendAASMessage->v_varValue.value.valueunion.val_string_vec.value[1], pNodeStoreFunctions->v_IPAddressServer);
	OV_ANY tmpServername;
	ov_vendortree_getservername(&tmpServername, NULL);
	psendAASMessage->v_varValue.value.valueunion.val_string_vec.value[2] = NULL;
	ov_string_setvalue(&psendAASMessage->v_varValue.value.valueunion.val_string_vec.value[2], tmpServername.value.valueunion.val_string);
	psendAASMessage->v_varValue.value.valueunion.val_string_vec.value[3] = NULL;
	ov_string_setvalue(&psendAASMessage->v_varValue.value.valueunion.val_string_vec.value[3], "/TechUnits/openAAS/AASFolder/ComCo");
	ov_database_free(tmpHexString);

	OV_INSTPTR_ksapi_KSApiCommon pKSApiCommon = Ov_StaticPtrCast(ksapi_KSApiCommon, psendAASMessage);
	ksapi_KSApiCommon_Reset_set(pKSApiCommon, FALSE);
	ksapi_KSApiCommon_Reset_set(pKSApiCommon, TRUE);
	ksapi_KSApiCommon_Submit_set(pKSApiCommon, FALSE);
	ksapi_KSApiCommon_Submit_set(pKSApiCommon, TRUE);
	return;
}


void openaas_modelmanager_AASConvertListDelete(IdentificationType aasId){
	OV_INSTPTR_openaas_modelmanager pmodelmanager = NULL;
	OV_INSTPTR_openaas_AASConvertListType pListElement = NULL;

	pmodelmanager = Ov_StaticPtrCast(openaas_modelmanager, Ov_GetFirstChild(ov_instantiation, pclass_openaas_modelmanager));

	Ov_ForEachChildEx(ov_containment, Ov_StaticPtrCast(ov_domain, pmodelmanager), pListElement, openaas_AASConvertListType){
		if (ov_string_compare(pListElement->v_AASIdString, aasId.IdSpec) == OV_STRCMP_EQUAL && pListElement->v_AASIdType == aasId.IdType){
			if (Ov_Fail(Ov_DeleteObject(pListElement)))
				return;

			// Get the pointer to object for send the Message
			OV_INSTPTR_ksapi_setVar psendAASMessage = NULL;
			Ov_ForEachChildEx(ov_instantiation, pclass_ksapi_setVar, psendAASMessage, ksapi_setVar){
				if(ov_string_compare(psendAASMessage->v_identifier, "SendAASMessage") == OV_STRCMP_EQUAL){
					break;
				}
			}

			ov_string_setvalue(&psendAASMessage->v_serverHost, pNodeStoreFunctions->v_IPAddressAASDiscoveryServer);
			ov_string_setvalue(&psendAASMessage->v_serverName, pNodeStoreFunctions->v_ManagerNameAASDiscoveryServer);
			ov_string_setvalue(&psendAASMessage->v_path, pNodeStoreFunctions->v_PathToAASDiscoveryServer);
			ov_string_append(&psendAASMessage->v_path, ".DeleteOVDataForAAS");

			psendAASMessage->v_varValue.value.vartype = OV_VT_STRING;
			OV_STRING tmpHexString = NULL;
			ov_string_print(&tmpHexString, "%x", aasId.IdType);

			for (OV_UINT i = 0; i < ov_string_getlength(aasId.IdSpec); i++){
				OV_STRING tmpHexString2 = NULL;
				ov_string_print(&tmpHexString2, "%x", aasId.IdSpec[i]);
				ov_string_append(&tmpHexString, tmpHexString2);
				ov_database_free(tmpHexString2);
			}
			psendAASMessage->v_varValue.value.valueunion.val_string = NULL;
			ov_string_setvalue(&psendAASMessage->v_varValue.value.valueunion.val_string, tmpHexString);
			ov_database_free(tmpHexString);

			OV_INSTPTR_ksapi_KSApiCommon pKSApiCommon = Ov_StaticPtrCast(ksapi_KSApiCommon, psendAASMessage);
			ksapi_KSApiCommon_Submit_set(pKSApiCommon, FALSE);
			ksapi_KSApiCommon_Submit_set(pKSApiCommon, TRUE);
			pmodelmanager->v_ListSize -= 1;
			return;
		}
	}
	return;
}

OV_STRING openaas_modelmanager_AASConvertListGet(IdentificationType aasId){
	OV_INSTPTR_openaas_modelmanager pmodelmanager = NULL;
	OV_INSTPTR_openaas_AASConvertListType pListElement = NULL;
	pmodelmanager = Ov_StaticPtrCast(openaas_modelmanager, Ov_GetFirstChild(ov_instantiation, pclass_openaas_modelmanager));

	if (pmodelmanager->v_ListSize == 0){
		return "";
	}

	Ov_ForEachChildEx(ov_containment, Ov_StaticPtrCast(ov_domain, pmodelmanager), pListElement, openaas_AASConvertListType){
		if (ov_string_compare(pListElement->v_AASIdString, aasId.IdSpec) == OV_STRCMP_EQUAL && pListElement->v_AASIdType == aasId.IdType){
			return pListElement->v_AASPath;
		}
	}
	return "";
}




OV_DLLFNCEXPORT UA_NodeId openaas_modelmanager_getAASNodeId(IdentificationType aasId) {
    return UA_NODEID_STRING_ALLOC(pNodeStoreFunctions->v_NameSpaceIndexNodeStoreInterface, openaas_modelmanager_AASConvertListGet(aasId));;
}


OV_DLLFNCEXPORT AASStatusCode openaas_modelmanager_ovresultToAASStatusCode(OV_RESULT result) {
	switch(result){
	case OV_ERR_OK:
		return AASSTATUSCODE_GOOD;
	default:
		return AASSTATUSCODE_BADUNEXPECTEDERROR;
	}
}




OV_DLLFNCEXPORT OV_ACCESS openaas_modelmanager_getaccess(
	OV_INSTPTR_ov_object	pobj,
	const OV_ELEMENT		*pelem,
	const OV_TICKET			*pticket
) {
    /*
    *   local variables
    */
    return (OV_ACCESS)(OV_AC_WRITE | OV_AC_READ | OV_AC_LINKABLE | OV_AC_UNLINKABLE | OV_AC_DELETEABLE | OV_AC_RENAMEABLE);
}


OV_DLLFNCEXPORT OV_RESULT openaas_modelmanager_constructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*
    *   local variables
    */
    //OV_INSTPTR_openaas_modelmanager pinst = Ov_StaticPtrCast(openaas_modelmanager, pobj);
    OV_RESULT    result;

    /* do what the base class does first */
    result = ov_object_constructor(pobj);
    if(Ov_Fail(result))
         return result;

    /* do what */


    return OV_ERR_OK;
}

OV_DLLFNCEXPORT void openaas_modelmanager_destructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*
    *   local variables
    */
    //OV_INSTPTR_openaas_modelmanager pinst = Ov_StaticPtrCast(openaas_modelmanager, pobj);

    /* do what */

    /* destroy object */
    ov_object_destructor(pobj);

    return;
}



OV_DLLFNCEXPORT void openaas_modelmanager_startup(
	OV_INSTPTR_ov_object 	pobj
) {
    /*
    *   local variables
    */
    //OV_INSTPTR_openaas_modelmanager pinst = Ov_StaticPtrCast(openaas_modelmanager, pobj);

    /* do what the base class does first */
    ov_object_startup(pobj);

    /* do what */

    // Add InformationModel & NodeStoreInterface & Reference to AASFolder
    UA_StatusCode ret = UA_STATUSCODE_GOOD;
    OV_INSTPTR_openaas_nodeStoreFunctions pNodeStoreFunctions = NULL;
    pNodeStoreFunctions = Ov_StaticPtrCast(openaas_nodeStoreFunctions, Ov_GetFirstChild(ov_instantiation, pclass_openaas_nodeStoreFunctions));
    ret = opcua_uaServer_addInformationModel(&pNodeStoreFunctions->v_NodeStoreInterface, "http://acplt.org/AAS/Ov", "/TechUnits/openAAS", nodeset_returnIndices, &pNodeStoreFunctions->v_NameSpaceIndexInformationModel, &pNodeStoreFunctions->v_NameSpaceIndexNodeStoreInterface, UA_OPENAAS, UA_OPENAAS_COUNT);
	if (ret != UA_STATUSCODE_GOOD){
		ov_logfile_error("openaas: Fatal: Couldn't add InformationModel");
	}

    return;
}

